
{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Painel de Controle | SisCoE{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        :root {
            --header-bg: #1f2937;
            --body-bg: #111827;
            --card-bg: #1f2937;
            --text-color: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --healthy-color: #22c55e;
            --warning-color: #f59e0b;
            --down-color: #ef4444;
        }
        .theme-light {
            --header-bg: #ffffff;
            --body-bg: #f9fafb;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
        }
        body {
            background-color: var(--body-bg);
            color: var(--text-color);
        }
        .status-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-indicator.healthy { background-color: var(--healthy-color); }
        .status-indicator.warning { background-color: var(--warning-color); }
        .status-indicator.down { background-color: var(--down-color); }
        .status-indicator.error { background-color: var(--down-color); }

        .progress-bar { background-color: #374151; }
        .progress-fill.healthy { background-color: var(--healthy-color); }
        .progress-fill.warning { background-color: var(--warning-color); }
        .progress-fill.down { background-color: var(--down-color); }
        
        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-healthy { background-color: var(--healthy-color); color: white; }
        .badge-warning { background-color: var(--warning-color); color: white; }
        .badge-down { background-color: var(--down-color); color: white; }
        .badge-running { background-color: var(--healthy-color); color: white; }
        .badge-exited { background-color: var(--text-muted); color: white; }
        .badge-restarting { background-color: var(--warning-color); color: white; }
        .badge-error { background-color: var(--down-color); color: white; }
    </style>
{% endblock %}

{% block content %}
<div id="content-main" class="p-6 space-y-6">
    {% csrf_token %}
    
    <!-- CABE√áALHO -->
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">üöÄ Painel de Controle</h1>
        <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-400">Atualizado em: <span id="last-updated">--:--:--</span></span>
            <button id="refresh-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
        </div>
    </div>

    <!-- SE√á√ÉO A: STATUS EM TEMPO REAL E M√âTRICAS -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Card: Status dos Servi√ßos Core -->
        <div class="lg:col-span-1 bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-heartbeat mr-2"></i>Status dos Servi√ßos</h2>
            <div id="service-status-list" class="space-y-4">
                {% for name, service in service_status.items %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="status-indicator {{ service.status }}"></div>
                        <span class="ml-3 text-lg">{{ name|capfirst }}</span>
                    </div>
                    <div class="text-right">
                        <span class="font-mono text-sm text-gray-400">{{ service.message }}</span>
                        <div class="text-xs text-gray-500">{{ service.version }}</div>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-400">Nenhum servi√ßo para monitorar.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Card: M√©tricas do Sistema -->
        <div class="lg:col-span-2 bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-tachometer-alt mr-2"></i>M√©tricas do Sistema</h2>
            <div id="system-metrics-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- CPU -->
                <div>
                    <label class="text-sm font-medium text-gray-400">Uso de CPU</label>
                    <div class="flex items-center mt-1">
                        <div class="w-full progress-bar rounded-full h-4">
                            <div id="cpu-progress" class="progress-fill healthy rounded-full h-4" style="width: {{ system_metrics.cpu_usage }}%;"></div>
                        </div>
                        <span id="cpu-usage" class="ml-4 font-bold text-lg">{{ system_metrics.cpu_usage|floatformat:1 }}%</span>
                    </div>
                </div>
                <!-- Mem√≥ria -->
                <div>
                    <label class="text-sm font-medium text-gray-400">Uso de Mem√≥ria</label>
                    <div class="flex items-center mt-1">
                        <div class="w-full progress-bar rounded-full h-4">
                            <div id="mem-progress" class="progress-fill healthy rounded-full h-4" style="width: {{ system_metrics.memory_usage }}%;"></div>
                        </div>
                        <span id="mem-usage" class="ml-4 font-bold text-lg">{{ system_metrics.memory_usage|floatformat:1 }}%</span>
                    </div>
                    <div class="text-xs text-gray-500 text-right mt-1">
                        <span id="mem-details">{{ system_metrics.memory_used_gb }}GB / {{ system_metrics.memory_total_gb }}GB</span>
                    </div>
                </div>
                <!-- Disco -->
                <div>
                    <label class="text-sm font-medium text-gray-400">Uso de Disco</label>
                    <div class="flex items-center mt-1">
                        <div class="w-full progress-bar rounded-full h-4">
                            <div id="disk-progress" class="progress-fill healthy rounded-full h-4" style="width: {{ system_metrics.disk_usage }}%;"></div>
                        </div>
                        <span id="disk-usage" class="ml-4 font-bold text-lg">{{ system_metrics.disk_usage|floatformat:1 }}%</span>
                    </div>
                    <div class="text-xs text-gray-500 text-right mt-1">
                        <span id="disk-details">{{ system_metrics.disk_free_gb }}GB livres / {{ system_metrics.disk_total_gb }}GB</span>
                    </div>
                </div>
                <!-- Uptime -->
                <div class="flex flex-col justify-center">
                     <label class="text-sm font-medium text-gray-400">Uptime do Sistema</label>
                     <span id="uptime-display" class="text-2xl font-bold text-green-400">{{ system_metrics.uptime_display }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SE√á√ÉO B, C e D: INFO, FERRAMENTAS, A√á√ïES -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Card: Status dos Containers -->
        <div class="bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4"><i class="fab fa-docker mr-2"></i>Status dos Containers</h2>
            <div id="container-status-list" class="space-y-3">
                {% for container in container_status %}
                <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-700">
                    <div class="flex items-center">
                        <i class="fas fa-box-open text-gray-400 mr-3"></i>
                        <span class="font-medium">{{ container.name }}</span>
                    </div>
                    <span class="badge badge-{{ container.status }}">{{ container.status }}</span>
                </div>
                {% empty %}
                <p class="text-gray-400">N√£o foi poss√≠vel carregar o status dos containers.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Card: Informa√ß√µes Django -->
        <div class="bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4"><i class="fab fa-python mr-2"></i>Informa√ß√µes Django</h2>
            <div id="django-info-grid" class="grid grid-cols-2 gap-4 text-sm">
                <div class="flex justify-between border-b border-gray-700 py-1">
                    <span class="text-gray-400">Vers√£o:</span>
                    <span class="font-mono">{{ django_info.version|default:"N/A" }}</span>
                </div>
                <div class="flex justify-between border-b border-gray-700 py-1">
                    <span class="text-gray-400">Modo Debug:</span>
                    {% if django_info.debug %}
                        <span class="font-bold text-yellow-400">ATIVO</span>
                    {% else %}
                        <span class="font-bold text-green-400">INATIVO</span>
                    {% endif %}
                </div>
                <div class="flex justify-between border-b border-gray-700 py-1">
                    <span class="text-gray-400">Apps Instaladas:</span>
                    <span class="font-mono">{{ django_info.installed_apps }}</span>
                </div>
                <div class="flex justify-between border-b border-gray-700 py-1">
                    <span class="text-gray-400">Models:</span>
                    <span class="font-mono">{{ django_info.models_count }}</span>
                </div>
            </div>
        </div>

        <!-- Card: A√ß√µes R√°pidas -->
        <div class="bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-bolt mr-2"></i>A√ß√µes R√°pidas</h2>
            <div id="quick-actions-grid" class="grid grid-cols-2 gap-4">
                <button data-action="clear-cache" class="action-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition w-full">
                    <i class="fas fa-broom mr-2"></i>Limpar Cache
                </button>
                <button data-action="send-test-email" class="action-btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded transition w-full">
                    <i class="fas fa-envelope mr-2"></i>Testar Email
                </button>
                <button data-action="health-check" class="action-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition w-full">
                    <i class="fas fa-check-circle mr-2"></i>Health Check
                </button>
                 <button data-action="backup-db" class="action-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition w-full">
                    <i class="fas fa-database mr-2"></i>Backup DB
                </button>
                <button data-action="restart-service" data-service="web" class="action-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition w-full">
                    <i class="fas fa-sync-alt mr-2"></i>Reiniciar Web
                </button>
                <button data-action="restart-service" data-service="celery" class="action-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition w-full">
                    <i class="fas fa-sync-alt mr-2"></i>Reiniciar Celery
                </button>
            </div>
        </div>

    <!-- NOVO CARD: Ferramentas Externas Integradas -->
    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4"><i class="fas fa-external-link-alt mr-2"></i>Ferramentas Externas</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for tool in external_tools %}
            <a href="{{ tool.url }}" target="_blank" class="flex items-center justify-between p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition">
                <div class="flex items-center">
                    <span class="text-lg mr-3">{{ tool.icon }}</span>
                    <span class="font-medium">{{ tool.name }}</span>
                </div>
                <div class="flex items-center">
                    <div class="status-indicator {{ tool.status }}"></div>
                    <span class="ml-2 text-sm text-gray-400">{{ tool.status|capfirst }}</span>
                </div>
            </a>
            {% empty %}
            <p class="text-gray-400 col-span-full">Nenhuma ferramenta externa configurada.</p>
            {% endfor %}
        </div>
    </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refresh-btn');
    const lastUpdatedEl = document.getElementById('last-updated');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function showToast(message, type = 'success') {
        const colors = {
            success: 'linear-gradient(to right, #00b09b, #96c93d)',
            error: 'linear-gradient(to right, #ff5f6d, #ffc371)',
            info: 'linear-gradient(to right, #007bff, #00a6ff)',
        };
        Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            stopOnFocus: true,
            style: {
                background: colors[type] || colors.info,
            },
        }).showToast();
    }

    function updateUI(data) {
        // Update last updated time
        lastUpdatedEl.textContent = new Date().toLocaleTimeString();

        // Update System Metrics
        const metrics = data.system_metrics;
        if (metrics && !metrics.error) {
            document.getElementById('cpu-usage').textContent = metrics.cpu_usage.toFixed(1) + '%';
            document.getElementById('cpu-progress').style.width = metrics.cpu_usage + '%';
            
            document.getElementById('mem-usage').textContent = metrics.memory_usage.toFixed(1) + '%';
            document.getElementById('mem-progress').style.width = metrics.memory_usage + '%';
            document.getElementById('mem-details').textContent = `${metrics.memory_used_gb}GB / ${metrics.memory_total_gb}GB`;

            document.getElementById('disk-usage').textContent = metrics.disk_usage.toFixed(1) + '%';
            document.getElementById('disk-progress').style.width = metrics.disk_usage + '%';
            document.getElementById('disk-details').textContent = `${metrics.disk_free_gb}GB livres / ${metrics.disk_total_gb}GB`;
            
            document.getElementById('uptime-display').textContent = metrics.uptime_display;
        }

        // Update Service Status
        const services = data.service_status;
        const serviceList = document.getElementById('service-status-list');
        if (services && serviceList) {
            let html = '';
            for (const [name, service] of Object.entries(services)) {
                html += `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="status-indicator ${service.status}"></div>
                        <span class="ml-3 text-lg">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
                    </div>
                    <div class="text-right">
                        <span class="font-mono text-sm text-gray-400">${service.message}</span>
                        <div class="text-xs text-gray-500">${service.version}</div>
                    </div>
                </div>`;
            }
            serviceList.innerHTML = html;
        }
        
        // Update Container Status
        const containers = data.container_status;
        const containerList = document.getElementById('container-status-list');
        if (containers && containerList) {
            let html = '';
            containers.forEach(container => {
                html += `
                <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-700">
                    <div class="flex items-center">
                        <i class="fas fa-box-open text-gray-400 mr-3"></i>
                        <span class="font-medium">${container.name}</span>
                    </div>
                    <span class="badge badge-${container.status}">${container.status}</span>
                </div>`;
            });
            containerList.innerHTML = html || '<p class="text-gray-400">N√£o foi poss√≠vel carregar o status dos containers.</p>';
        }
    }

    function fetchData() {
        refreshBtn.disabled = true;
        refreshBtn.classList.add('opacity-50');

        fetch("{% url 'control_panel:api_health' %}")
            .then(response => response.ok ? response.json() : Promise.reject('Network response was not ok'))
            .then(data => {
                updateUI(data);
            })
            .catch(error => {
                console.error('Error fetching dashboard data:', error);
                showToast('Erro ao atualizar dados.', 'error');
            })
            .finally(() => {
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('opacity-50');
            });
    }

    function handleAction(e) {
        const button = e.target.closest('.action-btn');
        if (!button) return;

        const action = button.dataset.action;
        const service = button.dataset.service;
        let url, body;

        switch(action) {
            case 'clear-cache':
                url = "{% url 'control_panel:api_clear_cache' %}";
                break;
            case 'send-test-email':
                url = "{% url 'control_panel:api_send_test_email' %}";
                break;
            case 'health-check':
                url = "{% url 'control_panel:api_run_health_check' %}";
                break;
            case 'backup-db':
                url = "{% url 'control_panel:api_backup_database' %}";
                break;
            case 'restart-service':
                url = "{% url 'control_panel:api_restart_service' %}";
                body = new FormData();
                body.append('service', service);
                break;
            default:
                return;
        }

        button.disabled = true;
        button.classList.add('opacity-50');

        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: body || null
        })
        .then(response => response.json().then(data => ({ok: response.ok, data})))
        .then(({ok, data}) => {
            if (ok) {
                showToast(data.message || 'A√ß√£o executada com sucesso!', 'success');
                if (action === 'restart-service') {
                    showToast('Atualizando em 5s...', 'info');
                    setTimeout(fetchData, 5000);
                }
            } else {
                throw new Error(data.message || 'Ocorreu um erro.');
            }
        })
        .catch(error => {
            console.error(`Error performing action ${action}:`, error);
            showToast(error.message, 'error');
        })
        .finally(() => {
            button.disabled = false;
            button.classList.remove('opacity-50');
        });
    }

    // Initial fetch and set interval
    fetchData();
    setInterval(fetchData, 30000);

    // Event Listeners
    refreshBtn.addEventListener('click', fetchData);
    document.getElementById('quick-actions-grid').addEventListener('click', handleAction);
});
</script>
{% endblock %}
