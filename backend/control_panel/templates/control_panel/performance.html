
{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Performance | Painel de Controle | SisCoE{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --header-bg: #1f2937;
            --body-bg: #111827;
            --card-bg: #1f2937;
            --text-color: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
        }
        body {
            background-color: var(--body-bg);
            color: var(--text-color);
        }
        .metric-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        .metric-value {
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 1;
        }
        .metric-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
    </style>
{% endblock %}

{% block content %}
<div id="content-main" class="p-6 space-y-6">
    
    <!-- CABEÇALHO -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold"><i class="fas fa-chart-line mr-2"></i>Performance da Aplicação</h1>
        <a href="{% url 'control_panel:dashboard' %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            <i class="fas fa-arrow-left mr-2"></i>Voltar ao Dashboard
        </a>
    </div>

    <!-- SEÇÃO DE MÉTRICAS DE PERFORMANCE -->
    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Métricas da Aplicação</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <!-- Tempo Médio de Resposta -->
            <div class="metric-card">
                <div class="metric-value text-blue-400">{{ performance_metrics.average_response_time_ms|default:"0" }} ms</div>
                <div class="metric-label">Tempo Médio de Resposta</div>
            </div>
            <!-- Taxa de Erro -->
            <div class="metric-card">
                <div class="metric-value text-red-400">{{ performance_metrics.error_rate|default:"0" }}%</div>
                <div class="metric-label">Taxa de Erro (4xx + 5xx)</div>
            </div>
            <!-- Total de Requisições -->
            <div class="metric-card">
                <div class="metric-value text-green-400">{{ performance_metrics.total_requests|default:"0" }}</div>
                <div class="metric-label">Total de Requisições</div>
            </div>
            <!-- Requisições por Segundo (Placeholder) -->
            <div class="metric-card">
                <div class="metric-value text-yellow-400">{{ performance_metrics.requests_per_second|default:"0" }}</div>
                <div class="metric-label">Requisições / Seg (RPS)</div>
            </div>
        </div>
        <div class="text-xs text-gray-500 mt-4">
            * As métricas são baseadas nas requisições processadas desde a última reinicialização do servidor. Requisições para o painel de controle não são contadas.
        </div>
    </div>

    <!-- SEÇÃO DE MÉTRICAS DO BANCO DE DADOS -->
    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Métricas do Banco de Dados</h2>
        {% if database_metrics.error %}
            <p class="text-red-400">Erro ao carregar métricas do banco de dados: {{ database_metrics.error }}</p>
        {% else %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Conexões -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Conexões</h3>
                    <div class="flex items-baseline space-x-4">
                        <div class="metric-card w-full">
                            <div class="metric-value text-purple-400">{{ database_metrics.active_connections }}</div>
                            <div class="metric-label">Conexões Ativas</div>
                        </div>
                        <div class="metric-card w-full">
                            <div class="metric-value text-gray-400">{{ database_metrics.total_connections }}</div>
                            <div class="metric-label">Conexões Totais</div>
                        </div>
                    </div>
                </div>
                <!-- Tabelas Mais Ativas -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Tabelas com Mais Linhas</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-4 py-2">Schema</th>
                                    <th scope="col" class="px-4 py-2">Tabela</th>
                                    <th scope="col" class="px-4 py-2 text-right">Linhas (Tuplas)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for schema, table, live_tuples in database_metrics.table_stats %}
                                <tr class="border-b border-gray-700 hover:bg-gray-600">
                                    <td class="px-4 py-2">{{ schema }}</td>
                                    <td class="px-4 py-2 font-medium text-white">{{ table }}</td>
                                    <td class="px-4 py-2 text-right font-mono">{{ live_tuples }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center py-4">Nenhuma estatística de tabela disponível.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

</div>
{% endblock %}
