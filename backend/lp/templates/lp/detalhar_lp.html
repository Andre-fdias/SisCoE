{% extends "base.html" %}
{% load static %}
{% block title %}Detalhar Licença Prêmio{% endblock %}
{% block 'body' %}

<style>
    /* Estilos da barra de progresso (adaptados do adicional) */
    .progress-bar-container {
        width: 100%;
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .progress-track {
        background-color: #d1d1d1;
        height: 10px;
        width: 100%;
        position: relative;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .progress-fill {
        background-color: #1a6fc9;
        height: 100%;
        width: 0%;
        border-radius: 5px;
        transition: width 0.3s ease-in-out;
    }
    
    .progress-steps {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transform: translateY(-50%);
        padding: 0;
        list-style: none;
    }
    
    .progress-step {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .step-indicator {
        background-color: #fff;
        color: #666666;
        border: 2px solid #666666;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        font-weight: bold;
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        z-index: 1;
    }
    
    .step-indicator.active {
        background-color: #1a6fc9;
        color: #fff;
        border-color: #1a6fc9;
    }
    
    .step-indicator.completed {
        background-color: #007700;
        color: #fff;
        border-color: #1a6fc9;
    }
    
    .step-indicator.completed svg {
        display: block;
    }
    
    .step-indicator svg {
        display: none;
        width: 14px;
        height: 14px;
    }
    
    .step-label {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: #666666;
        text-align: center;
        max-width: 80px;
        word-break: break-word;
    }
    
    .step-label.active,
    .step-label.completed {
        color: #1a6fc9;
        font-weight: bold;
    }
    .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        min-width: 300px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .alert-success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    
    .alert-error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
        100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
    }
    
    .faz-jus-glow {
        animation: pulse-glow 2s infinite;
    }
    
    .step-faz-jus .progress-indicator {
        background-color: #10b981 !important;
        color: white !important;
        border-color: #10b981 !important;
    }
    #novoLpModal {
    animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>

<body class="bg-gray-100">

  <div data-status="{{ lp.status_lp }}">
    <div class="md:items-center md:justify-between rounded-lg mt-4 w-full" id="cad_efetivo">
    
        <!-- Cabeçalho -->
        <fieldset class="p-4 rounded-md w-full">
            <fieldset class="bg-gradient-to-r from-gray-700 to-gray-900 rounded-md shadow-lg mb-2 border-0">
                <div class="p-4">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <h1 class="text-3xl font-bold text-white tracking-tight drop-shadow-md">Licença Prêmio (LP)</h1>
                            <p class="text-gray-300 text-sm mt-1">Informações completas sobre a licença prêmio</p>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                            <a href="{% url 'lp:listar_lp' %}" 
                               class="text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:bg-gradient-to-br
                                      focus:ring-4 focus:outline-none focus:ring-blue-400 shadow-lg shadow-blue-600/50
                                      font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-all duration-200">
                                Voltar
                            </a>
                        </div>
                    </div>
                </div>
            </fieldset>
        </fieldset>

        <!-- Mensagens de alerta -->
        <fieldset class="rounded-md">
            {% if messages %}
                <div id="django-messages" style="display:none;" data-messages='[
                    {% for message in messages %}
                        {
                            "tags": "{{ message.tags|upper }}",
                            "message": "{{ message|escapejs }}"
                        }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]'></div>
            {% endif %}
            {% include 'modals/modal_alerts.html' %}
        </fieldset>

        <!-- Perfil do Militar -->
        <fieldset class="p-4 mb-2 rounded-md w-full max-w-full">
            <div class="bg-gradient-to-r from-gray-700 to-gray-900 rounded-2xl shadow-2xl w-full p-8 transition-all duration-300 animate-fade-in">
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="flex-shrink-0 flex flex-col items-center md:block">
                        <div class="relative group overflow-hidden rounded-xl border-4 border-blue-400/30 shadow-xl hover:shadow-2xl transition-all duration-300 w-60 h-72">
                            {% if lp.cadastro.imagens.exists %}
                            <img src="{{ lp.cadastro.imagens.last.image.url }}"
                                class="w-full h-full object-cover transform transition-transform duration-300 group-hover:scale-105"
                                alt="Foto de {{ lp.cadastro.nome }}">
                            {% else %}
                            <div class="w-full h-full bg-blue-200/20 flex flex-col items-center justify-center text-blue-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <span class="text-lg font-medium">Sem imagem</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
        
                    <div class="flex-1 space-y-2">
                        <div class="space-y-2">
                            <h1 class="text-4xl font-bold text-white text-center md:text-left">{{ lp.cadastro.nome }}</h1>
                            <div class="flex justify-center md:justify-start">
                                <div class="mt-2 rounded-xl ">
                                    <p class="text-xl font-bold text-white">
                                        {{ lp.cadastro.promocoes.last.grad|safe }}
                                    </p>
                                </div>
                                <div class="inline-flex items-center bg-blue-800/40 px-4 py-2 rounded-full">
                                    <span class="text-xl font-mono text-blue-200">
                                        {{ lp.cadastro.re }}-{{ lp.cadastro.dig }}
                                    </span>
                                </div>
                            </div>
                        </div>
        
                        <div class="grid md:grid-cols-2 gap-6 ">
                            <div class="w-full bg-gray-800/30 p-4 rounded-xl border border-gray-700/50">
                                <h2 class="text-xl font-semibold text-white mb-2 pb-2 border-b border-gray-600/50">
                                    <span class="bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent">
                                        Informações de Contato
                                    </span>
                                </h2>
                                <ul class="space-y-4">
                                    <li class="flex items-start gap-3">
                                        <svg class="flex-shrink-0 w-6 h-6 text-blue-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                        </svg>
                                        <div>
                                            <p class="font-medium text-blue-200">E-mail Institucional</p>
                                            <p class="text-white break-all">{{ lp.cadastro.email|default:"-" }}</p>
                                        </div>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <svg class="flex-shrink-0 w-6 h-6 text-blue-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                        </svg>
                                        <div>
                                            <p class="font-medium text-blue-200">Contato Telefônico</p>
                                            <p class="text-white">{{ lp.cadastro.telefone|default:"-" }}</p>
                                        </div>
                                    </li>
                                </ul>
                            </div>
        
                            <div class="w-full bg-gray-800/30 p-4 rounded-xl border border-gray-700/50">
                                <h2 class="text-xl font-semibold text-white mb-2 pb-2 border-b border-gray-600/50">
                                    <span class="bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent">
                                        Situação Atual
                                    </span>
                                </h2>
                                <ul class="space-y-4">
                                    <li class="flex items-start gap-3">
                                        <svg class="flex-shrink-0 w-6 h-6 text-blue-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                        <div>
                                            <p class="font-medium text-blue-200">Localização/Posto</p>
                                            <p class="text-white">
                                                {{ lp.cadastro.detalhes_situacao.last.sgb|default:"-" }} -
                                                {{ lp.cadastro.detalhes_situacao.last.posto_secao|default:"-" }}
                                            </p>
                                        </div>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <svg class="flex-shrink-0 w-6 h-6 text-blue-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        <div>
                                            <p class="font-medium text-blue-200">Última Atualização</p>
                                            <p class="text-white">
                                                {{ lp.cadastro.detalhes_situacao.last.modified|date:"d/m/Y"|default:"-" }}
                                            </p>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- Licença Prêmio -->
            <div class="p-4 mb-4 rounded-lg w-full max-w-full">
                <!-- Barra de status -->
                
<style>
    /* Estilos da barra de progresso (adaptados do adicional) */
    .progress-bar-container {
        width: 100%;
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .progress-track {
        background-color: #d1d1d1;
        height: 10px;
        width: 100%;
        position: relative;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .progress-fill {
        background-color: #1a6fc9;
        height: 100%;
        width: 0%;
        border-radius: 5px;
        transition: width 0.3s ease-in-out;
    }
    
    .progress-steps {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transform: translateY(-50%);
        padding: 0;
        list-style: none;
    }
    
    .progress-step {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .step-indicator {
        background-color: #fff;
    }

    /* Adicione estas classes para o efeito de brilho se ainda não tiver */
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } /* green-500 */
        70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .faz-jus-glow {
        animation: pulse-glow 2s infinite;
    }
</style>


<!-- Dados de fuição -->

<fieldset class="bg-gray-50 mb-8 rounded-2xl shadow-lg 6 ">
   
       
            {% if lp.status_lp == 'concluido' and lp.previsao_associada %}
                {% include 'fruicao/fruicao_detalhes.html' with fruicao=lp.previsao_associada %}
            {% else %}
                <div class="">
                 
                </div>
            {% endif %}
       
   
</fieldset>

{# Botão de Toggle - Versão Melhorada #}
{% if lp.status_lp == "concluido" %}
<div class="mb-6 flex justify-start">
    <button id="toggleLpDetails" 
            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-800 text-white font-semibold rounded-xl shadow-lg 
                   hover:from-blue-700 hover:to-blue-900 transform hover:scale-[1.02] transition-all duration-300 
                   focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-70 flex items-center gap-3
                   group relative overflow-hidden">
        <!-- Efeito de brilho no hover -->
        <span class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity duration-300"></span>
        
        <!-- Ícone animado -->
        <div class="relative w-6 h-6 flex items-center justify-center">
            <i class="fas fa-chevron-down absolute transition-all duration-300 transform group-[[aria-expanded=true]]:-translate-y-full group-[[aria-expanded=true]]:opacity-0"></i>
            <i class="fas fa-chevron-up absolute transition-all duration-300 transform translate-y-full opacity-0 group-[[aria-expanded=true]]:translate-y-0 group-[[aria-expanded=true]]:opacity-100"></i>
        </div>
        
        <span id="toggleText">Clique aqui para mostrar detalhes da Concessão</span>
    </button>
</div>
{% endif %}

{# Conteúdo com transição suave #}
<div id="lpDetailsContent" 
     {% if lp.status_lp == "concluido" %} 
         class="transition-all duration-500 ease-in-out overflow-hidden max-h-0"
     {% else %}
         class="transition-all duration-500 ease-in-out"
     {% endif %}>


<fieldset class="bg-gray-50 mb-4 rounded-2xl shadow-lg p-6 border border-gray-300">
    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
            Informações da Licença Prêmio
        </div>
    </h3>

    <div class="progress-container bg-gray-50 rounded-xl p-6 mb-4" data-status="{{ lp.status_lp }}">
        <div class="relative w-full mb-2">
            <div class="progress-bg absolute top-1/2 left-0 right-0 h-1.5 bg-gray-200 -translate-y-1/2 z-0 rounded-full"></div>
            
            <div class="progress-active absolute top-1/2 left-0 h-1.5 bg-blue-500 -translate-y-1/2 z-10 rounded-full transition-all duration-500 ease-in-out"
                style="width: {{ lp.get_progress_percentage }}%;"></div>
            
            <div class="relative flex justify-between z-20">
                {% for status_key, status_label in StatusLP_choices %}
                <div class="step flex flex-col items-center w-full">
                    <div class="progress-indicator w-6 h-6 rounded-full flex items-center justify-center relative
                                {% if lp.get_progress_percentage_by_status > forloop.counter0 %}bg-blue-900 text-white
                                {% elif lp.status_lp == status_key %}bg-white border-[3px] border-blue-800 text-blue-600
                                {% else %}bg-white border border-gray-200 text-gray-500{% endif %}
                                {% if status_key == 'apta_concessao' %}ring-2 ring-offset-2 ring-green-500{% endif %}">
                        {% if lp.get_progress_percentage_by_status > forloop.counter0 %}
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                        </svg>
                        {% else %}
                        <span class="text-[10px]">{{ forloop.counter }}</span>
                        {% endif %}
                    </div>
                    <div class="progress-label mt-2 text-xs text-center max-w-[90px] px-1 leading-tight
                                {% if lp.get_progress_percentage_by_status >= forloop.counter0 %}text-blue-800 font-medium
                                {% else %}text-gray-600{% endif %}
                                {% if status_key == 'apta_concessao' %}font-bold text-green-700{% endif %}">
                        {{ status_label }}
                        {% if status_key == 'apta_concessao' and lp.status_lp == 'apta_concessao' %}
                        <span class="animate-pulse">✨</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        {% if lp.status_lp == 'apta_concessao' %}
        <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center">
            <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="text-green-700 font-medium">Esta LP está apta para concessão!</span>
        </div>
        {% endif %}

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Funções para mostrar/ocultar o campo da 6ª parte no modal de LP (manter, se usado)
                window.toggleSextaParteLp = function() {
                    const numeroProxLpSelect = document.getElementById('numero_prox_lp_select');
                    const sextaParteContainerLp = document.getElementById('sexta_parte_container_lp');
                    const sextaParteCheckboxLp = document.getElementById('sexta_parte_lp_checkbox');
                    const numeroProx = numeroProxLpSelect ? parseInt(numeroProxLpSelect.value) : null;

                    if (!isNaN(numeroProx) && numeroProx === 4) { // Assumindo que 4 é a LP que habilita 6ª parte
                        sextaParteContainerLp.classList.remove('hidden');
                    } else {
                        sextaParteContainerLp.classList.add('hidden');
                        if(sextaParteCheckboxLp) { // Verificar se o checkbox existe antes de tentar desmarcá-lo
                            sextaParteCheckboxLp.checked = false;
                        }
                    }
                }

                // Função para exibir mensagens de alerta customizadas (manter, se usado)
                window.showAlertMessage = function(message, type) {
                    const alertDiv = document.getElementById('customAlert'); // Certifique-se que você tem este div no seu base.html ou em detalhar_lp.html
                    if (!alertDiv) {
                        console.warn("Elemento #customAlert não encontrado. A mensagem de alerta não será exibida.");
                        alert(message); // Fallback para alert padrão
                        return;
                    }
                    const alertIcon = alertDiv.querySelector('#customAlertIcon');
                    const alertMessage = alertDiv.querySelector('#customAlertMessage');

                    alertDiv.classList.remove('alert-success', 'alert-error', 'alert-info', 'hidden');
                    // Remover classes de cor antigas para evitar conflitos
                    alertDiv.classList.remove('bg-green-100', 'border-green-400', 'text-green-800',
                                            'bg-red-100', 'border-red-400', 'text-red-800',
                                            'bg-blue-100', 'border-blue-400', 'text-blue-800');

                    let iconSvg = '';
                    if (type === 'success') {
                        alertDiv.classList.add('bg-green-100', 'border-green-400', 'text-green-800');
                        iconSvg = `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    } else if (type === 'error') {
                        alertDiv.classList.add('bg-red-100', 'border-red-400', 'text-red-800');
                        iconSvg = `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    } else { // info ou default
                        alertDiv.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-800');
                        iconSvg = `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    }
                    if (alertIcon) alertIcon.innerHTML = iconSvg;
                    if (alertMessage) alertMessage.innerText = message;

                    alertDiv.classList.remove('hidden');
                    setTimeout(() => {
                        alertDiv.classList.add('hidden');
                    }, 5000);
                }


                // Lógica para a barra de progresso
                function atualizarBarraProgresso() {
                    let statusChoicesRaw = '';
                    try {
                        // Certifique-se de que o ID 'lp_status_choices' existe e está corretamente preenchido
                        const lpStatusChoicesElement = document.getElementById('lp_status_choices');
                        if (!lpStatusChoicesElement) {
                            console.error("Elemento 'lp_status_choices' não encontrado. Não é possível atualizar a barra de progresso.");
                            return;
                        }
                        statusChoicesRaw = lpStatusChoicesElement.textContent;
                    } catch (e) {
                        console.error("Erro ao obter textContent de 'lp_status_choices':", e);
                        return;
                    }
                    
                    let statusChoices = [];
                    try {
                        statusChoices = JSON.parse(statusChoicesRaw);
                    } catch (e) {
                        console.error("Erro ao analisar JSON de statusChoicesRaw:", e, "\nConteúdo bruto:", statusChoicesRaw);
                        return;
                    }

                    // A partir daqui, a ordem dos status no JavaScript será a mesma que a ordem
                    // definida na classe StatusLP em models.py (passada via StatusLP_choices_json).
                    const statusOrder = {};
                    statusChoices.forEach((item, index) => {
                        statusOrder[item[0]] = index; // Mapeia 'key' para 'index' (0-based)
                    });

                    const statusAtual = "{{ lp.status_lp }}";
                    const etapaAtualIndex = statusOrder[statusAtual] !== undefined ? statusOrder[statusAtual] : 0; // Garante 0 se não encontrado
                    const totalEtapas = Object.keys(statusOrder).length;
                    
                    let progresso = 0;
                    if (totalEtapas > 1) {
                         // Calcula a porcentagem do progresso baseado no índice 0 até o totalEtapas - 1
                        progresso = (etapaAtualIndex / (totalEtapas - 1)) * 100;
                    } else if (totalEtapas === 1) {
                        progresso = 100; // Se houver apenas 1 etapa, sempre 100%
                    }
                    
                    document.querySelector('.progress-active').style.width = `${progresso}%`;
                    
                    // Destaque da barra ativa para "apta_concessao"
                    const progressActiveElement = document.querySelector('.progress-active');
                    if (progressActiveElement) {
                        if (statusAtual === 'apta_concessao') {
                            progressActiveElement.classList.add('bg-green-500');
                            progressActiveElement.classList.remove('bg-blue-500'); // Garante que a cor azul seja removida
                        } else {
                            progressActiveElement.classList.remove('bg-green-500');
                            progressActiveElement.classList.add('bg-blue-500'); // Volta para azul se não for apta
                        }
                    }

                    document.querySelectorAll('.step').forEach((step, index) => {
                        const indicator = step.querySelector('.progress-indicator');
                        const label = step.querySelector('.progress-label');
                        
                        // Reset classes before applying new ones to avoid stale styles
                        indicator.className = 'progress-indicator w-6 h-6 rounded-full flex items-center justify-center relative';
                        label.className = 'progress-label mt-2 text-xs text-center max-w-[90px] px-1 leading-tight';
                        
                        const statusKeyAtStep = statusChoices[index] ? statusChoices[index][0] : null;

                        if (etapaAtualIndex > index) {
                            // Etapa concluída
                            indicator.classList.add('bg-blue-900', 'text-white');
                            indicator.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                            </svg>`;
                            label.classList.add('text-blue-800', 'font-medium'); // Adicionado font-medium para consistência
                        } else if (etapaAtualIndex === index) {
                            // Etapa atual
                            indicator.classList.add('bg-white', 'border-[3px]', 'border-blue-800', 'text-blue-600');
                            indicator.innerHTML = `<span class="text-[10px]">${index + 1}</span>`;
                            label.classList.add('text-blue-800', 'font-medium');
                        } else {
                            // Etapas futuras
                            indicator.classList.add('bg-white', 'border', 'border-gray-200', 'text-gray-500');
                            indicator.innerHTML = `<span class="text-[10px]">${index + 1}</span>`;
                            label.classList.add('text-gray-600');
                        }
                        
                        // Destaque especial para a etapa 'apta_concessao'
                        if (statusKeyAtStep === 'apta_concessao') {
                            indicator.classList.add('ring-2', 'ring-offset-2', 'ring-green-500');
                            label.classList.add('font-bold', 'text-green-700');
                            if (statusAtual === 'apta_concessao') { // Aplica glow apenas se o status atual for 'apta_concessao'
                                indicator.classList.add('faz-jus-glow');
                            }
                        }
                    });
                }
            
                atualizarBarraProgresso();
                
                // Monitora mudanças no status da LP periodicamente
                setInterval(function() {
                    fetch(window.location.href)
                        .then(response => response.text())
                        .then(html => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            // Procura o elemento com o atributo data-status, que agora está no .progress-container
                            const parsedProgressContainer = doc.querySelector('.progress-container[data-status]'); 
                            const originalStatus = "{{ lp.status_lp }}";
                            let novoStatus = null;

                            if (parsedProgressContainer && parsedProgressContainer.dataset.status) {
                                novoStatus = parsedProgressContainer.dataset.status;
                            }
                            
                            if (novoStatus && novoStatus !== originalStatus) {
                                if (novoStatus === 'apta_concessao') {
                                    showAlertMessage('O status foi atualizado para Apta para Concessão!', 'success');
                                }
                                // Recarrega a página para que a barra de progresso seja atualizada com novos dados do Django
                                location.reload(); 
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao verificar atualização de status:', error);
                            // Pode adicionar um showAlertMessage de erro aqui se desejar
                        });
                }, 300000); // 5 minutos em milissegundos (300 * 1000)
            });
        </script>
        <script id="lp_status_choices" type="application/json">
            {{ StatusLP_choices_json|safe }}
        </script>
    </div>
</fieldset>
                <!-- Cards de Informações da Licença Prêmio -->
                <fieldset class="bg-gray-50 mb-4 rounded-2xl shadow-lg p-6 border border-gray-300">
                    <!-- Seção Principal de Informações -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Coluna 1 - Informações Básicas -->
                        <div class="space-y-4 p-6 bg-gray-50 rounded-xl shadow-sm border 
                            {% if lp.status_lp == 'concedido' %}border-green-500{% else %}border-gray-300{% endif %}">
                            <div class="flex items-center justify-between mb-8">
                                <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                    Informações da LP
                                </h3>
                            </div>

                            <div class="space-y-4">
                                <!-- Card - Número da LP -->
                                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4 
                                    {% if lp.status_lp == 'concedido' %}border-green-500
                                    {% elif lp.status_lp == 'apta_concessao' %}border-green-300
                                    {% else %}border-blue-400{% endif %}">
                                    <span class="text-gray-700">Número da LP:</span>
                                    <span class="text-2xl font-semibold text-blue-900">{{ lp.numero_lp }}º LP</span>
                                </div>
                                
                                <!-- Card - Período Aquisitivo -->
                                <div class="p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4 
                                    {% if progresso_periodo_aquisitivo_percentual >= 100 %}border-green-500
                                    {% else %}border-blue-400{% endif %}">
                                    <div class="flex items-start justify-between mb-4">
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-800 mb-1">Período Aquisitivo</h3>
                                            <p class="text-sm text-gray-600">Progresso do período de 5 anos</p>
                                        </div>
                                        <div>
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border
                                                {% if progresso_periodo_aquisitivo_percentual >= 100 %}bg-green-100 text-green-800 border-green-300
                                                {% elif progresso_periodo_aquisitivo_percentual >= 80 %}bg-blue-100 text-blue-800 border-blue-300
                                                {% else %}bg-yellow-100 text-yellow-800 border-yellow-300{% endif %}">
                                                {% if progresso_periodo_aquisitivo_percentual >= 100 %}Período Completo
                                                {% elif progresso_periodo_aquisitivo_percentual >= 80 %}Próximo do Fim
                                                {% else %}Em Andamento{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-gray-600">Início do Período:</span>
                                            <span class="text-gray-800 font-medium">
                                                {{ data_inicio_periodo_lp|date:"d/m/Y" }}
                                            </span>
                                        </div>
                                        
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-gray-600">Fim do Período:</span>
                                            <span class="text-gray-800">
                                                {{ data_fim_periodo_lp|date:"d/m/Y" }}
                                            </span>
                                        </div>
                                        
                                        <div class="flex items-center justify-between py-2">
                                            <span class="text-gray-600">Tempo Decorrido:</span>
                                            <span class="text-gray-800 font-medium" id="tempo-decorrido-lp" 
                                                data-inicio-periodo="{{ data_inicio_periodo_lp|date:'Y-m-d' }}">
                                                Carregando...
                                            </span>
                                        </div>
                                        
                                        <div class="pt-2">
                                            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                                <div id="progresso-periodo-lp" class="h-full bg-blue-500 transition-all duration-500"></div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1 text-right">
                                                Progresso do período aquisitivo
                                            </div>
                                        </div>
                                    </div>
                                </div>


<!-- Card - Status -->
<div class="p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4 
    {% if lp.status_lp == 'concedido' %}border-green-500
    {% elif lp.status_lp == 'apta_concessao' %}border-green-300
    {% else %}border-blue-400{% endif %}">
    <div class="flex items-start justify-between mb-4">
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-1">Status da LP</h3>
        </div>
        <div>
<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border
    {% if lp.status_lp == 'aguardando_requisitos' %}
        {% if dias_restantes_periodo_lp > 0 %}bg-yellow-100 text-yellow-800 border-yellow-300
        {% else %} {# dias_restantes_periodo_lp <= 0 #}
            bg-green-100 text-green-800 border-green-300 {# Matches apta_concessao style as requested #}
        {% endif %}
    {% elif lp.status_lp == 'apta_concessao' %}bg-green-100 text-green-800 border-green-300
    {% elif lp.status_lp == 'concedido' %}bg-blue-100 text-blue-800 border-blue-300
    {% elif lp.status_lp == 'lancado_sipa' %}bg-purple-100 text-purple-800 border-purple-300
    {% elif lp.status_lp == 'publicado' %}bg-indigo-100 text-indigo-800 border-indigo-300
    {% elif lp.status_lp == 'concluido' %}bg-gray-300 text-gray-700 border-gray-400
    {% endif %}">
    {# Altera o texto do badge se o período aquisitivo estiver concluído, mesmo que o status_lp seja 'aguardando_requisitos' #}
    {% if lp.status_lp == 'aguardando_requisitos' and dias_restantes_periodo_lp <= 0 %}
        Período aquisitivo concluído
    {% else %}
        {{ lp.get_status_lp_display }}
    {% endif %}
</span>
        </div>
    </div>
    
    <div class="space-y-3">
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
            <span class="text-gray-600">Última Atualização:</span>
            <span class="text-gray-800 font-medium">
                {{ lp.data_atualizacao|date:"d/m/Y " }}
            </span>
        </div>
        
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
            <span class="text-gray-600">Dias de Desconto:</span>
            <span class="text-gray-800">{{ lp.dias_desconto_lp }} dias</span>
        </div>
        
        <div class="flex items-center justify-between py-2">
            <span class="text-gray-600">Progresso do Status:</span>
            <div class="w-1/2 bg-gray-200 rounded-full h-2">
                <div class="h-2 rounded-full 
                    {% if lp.status_lp == 'aguardando_requisitos' and dias_restantes_periodo_lp > 10 %}bg-yellow-400
                    {% elif lp.status_lp == 'aguardando_requisitos' and dias_restantes_periodo_lp > 0 %}bg-red-500
                    {% elif lp.status_lp == 'aguardando_requisitos' and dias_restantes_periodo_lp <= 0 %}bg-green-500
                    {% elif lp.status_lp == 'apta_concessao' %}bg-green-500
                    {% elif lp.status_lp == 'concedido' %}bg-blue-500
                    {% elif lp.status_lp == 'lancado_sipa' %}bg-purple-500
                    {% elif lp.status_lp == 'publicado' %}bg-indigo-500
                    {% elif lp.status_lp == 'concluido' %}bg-gray-500
                    {% endif %}" 
                    style="width: {{ lp.get_progress_percentage }}%">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mensagens de status -->
{% if lp.status_lp == 'aguardando_requisitos' %}
    {% if dias_restantes_periodo_lp > 0 %}
    <div class="p-3 bg-yellow-50 rounded-lg text-sm text-yellow-700">
        <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        Aguardando envio dos requisitos necessários
    </div>
    {% else %} {# dias_restantes_periodo_lp <= 0 #}
    <div class="p-3 bg-green-50 rounded-lg text-sm text-green-700">
        <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Período aquisitivo concluído! Aguardando envio dos requisitos.
    </div>
    {% endif %}
{% elif lp.status_lp == 'apta_concessao' %}
<div class="p-3 bg-green-50 rounded-lg text-sm text-green-700">
    <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    LP apta para concessão - Aguardando lançamento
</div>
{% elif lp.status_lp == 'lancado_sipa' %}
<div class="p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
    <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
    </svg>
    LP lançada no SIPA - Processo em andamento
</div>
{% elif lp.status_lp == 'publicado' %}
<div class="p-3 bg-indigo-50 rounded-lg text-sm text-indigo-700">
    <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
    </svg>
    LP publicada - Aguardando conclusão
</div>
{% endif %}


<!-- Botão de Confirmação SIPA -->
<div class="flex justify-start mt-8">
    {% if lp.lancamento_sipa %}
        <button class="px-6 py-3 bg-gray-100 text-green-600 rounded-lg border-2 border-green-500
                    flex items-center gap-2" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Lançado no SIPA
        </button>
    {% else %}
        <button onclick="openConfirmarSipaLpModal('{{ lp.pk }}')" 
                class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700
                    transition-colors duration-200 font-medium shadow-md text-xs
                    flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            Confirmar SIPA
        </button>
    {% endif %}
    
    {# Modal de Confirmação do SIPA #}
    {% include 'modals/confirmar_sipa_lp_modal.html' with lp=lp N_CHOICES=N_CHOICES %}
</div>

                                

                                       </div>
                        </div>
                        
                        <!-- Coluna 2 - Status e Previsões -->
                        <div class="space-y-4 p-6 bg-gray-50 rounded-xl shadow-sm border 
                            {% if lp.status_lp == 'concedido' %}border-green-500{% else %}border-gray-300{% endif %}">
                            <h3 class="text-xl mt-4 font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                                Status e Previsões
                            </h3>
                                                                
                            <div class="space-y-4">
                                <!-- Card - Progresso -->
                                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4 
                                    {% if progresso_periodo_aquisitivo_percentual >= 100 %}border-green-500
                                    {% else %}border-blue-400{% endif %}">
                                    <span class="text-gray-700">Progresso do Período:</span>
                                    <div class="inline-flex items-center gap-2">
                                        <span class="text-2xl font-semibold text-blue-900">
                                            {{ progresso_periodo_aquisitivo_percentual|floatformat:"0" }}%
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Card - Previsões -->
                                <div class="p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4 
                                    {% if progresso_periodo_aquisitivo_percentual >= 100 %}border-green-500
                                    {% else %}border-blue-400{% endif %}">
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-gray-600">Dias Decorridos:</span>
                                            <span class="text-gray-800">
                                                {{ dias_decorridos_periodo_lp }} de {{ total_dias_periodo_lp }} dias
                                            </span>
                                        </div>
                                        
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-gray-600">Dias Restantes:</span>
                                            <span class="text-gray-800">
                                                {{ dias_restantes_periodo_lp }} dias
                                            </span>
                                        </div>
                                        
                                        <div class="flex items-center justify-between py-2">
                                            <span class="text-gray-600">Porcentagem:</span>
                                            <span class="text-gray-800 font-medium">
                                                {{ progresso_periodo_aquisitivo_percentual|floatformat:"1" }}%
                                            </span>
                                        </div>
                                        
                                        <div class="pt-2">
                                            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                                <div class="h-full bg-blue-500" style="width: {{ progresso_periodo_aquisitivo_percentual }}%"></div>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1 text-right">
                                                Progresso do período aquisitivo
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Card - Alerta de Prazo -->
                                <div id="alerta-periodo-lp" class="p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4 
                                    {% if dias_restantes_periodo_lp <= 30 %}border-yellow-500
                                    {% else %}border-blue-400{% endif %}">
                                    <div class="flex items-start mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 
                                            {% if dias_restantes_periodo_lp <= 30 %}text-yellow-500
                                            {% else %}text-blue-500{% endif %}" 
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                        </svg>
                                        <h3 class="text-lg font-semibold 
                                            {% if dias_restantes_periodo_lp <= 30 %}text-yellow-800
                                            {% else %}text-blue-800{% endif %}">
                                            Status do Prazo
                                        </h3>
                                    </div>
                                    
                                    <div class="pl-8">
                                        <p id="texto-alerta-lp" class="text-sm 
                                            {% if dias_restantes_periodo_lp <= 30 %}text-yellow-700
                                            {% else %}text-blue-700{% endif %}">
                                            {% if dias_restantes_periodo_lp <= 30 %}
                                                Período aquisitivo está prestes a vencer!
                                            {% else %}
                                                Período aquisitivo em andamento
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <!-- Script para calcular tempo decorrido -->
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        // Elementos DOM
                        const tempoDecorridoEl = document.getElementById('tempo-decorrido-lp');
                        const progressoPeriodoEl = document.getElementById('progresso-periodo-lp');
                        const alertaPeriodoEl = document.getElementById('alerta-periodo-lp');
                        const textoAlertaEl = document.getElementById('texto-alerta-lp');
                        
                        // Obter data de início do período (do dataset do elemento)
                        const inicioPeriodoStr = tempoDecorridoEl ? tempoDecorridoEl.dataset.inicioPeriodo : null;

                        if (!inicioPeriodoStr) {
                            console.error("Data de início do período da LP não encontrada.");
                            return;
                        }

                        const inicioPeriodo = new Date(inicioPeriodoStr);
                        const hoje = new Date();
                        
                        // Calcular diferença de tempo
                        const diffEmMs = hoje - inicioPeriodo;
                        const diffEmDias = Math.floor(diffEmMs / (1000 * 60 * 60 * 24));
                        
                        // Calcular anos, meses e dias
                        const anos = Math.floor(diffEmDias / 365);
                        const meses = Math.floor((diffEmDias % 365) / 30); // Aproximação de meses
                        const dias = diffEmDias - (anos * 365) - (meses * 30); // Dias restantes após anos e meses
                        
                        // Atualizar elemento de tempo decorrido
                        if (tempoDecorridoEl) {
                            tempoDecorridoEl.textContent = `${anos} ano(s), ${meses} mês(es) e ${dias} dia(s)`;
                        }
                        
                        // Calcular progresso do período (5 anos = 1825 dias)
                        const totalDiasPeriodo = 5 * 365;
                        const progressoPercentual = Math.min((diffEmDias / totalDiasPeriodo) * 100, 100);
                        
                        // Atualizar barra de progresso
                        if (progressoPeriodoEl) {
                            progressoPeriodoEl.style.width = `${progressoPercentual}%`;
                        }
                        
                        // Verificar status do período
                        const diasRestantes = totalDiasPeriodo - diffEmDias;
                        
                        if (alertaPeriodoEl && textoAlertaEl) {
                            // Resetar classes para evitar acumulação
                            alertaPeriodoEl.classList.remove('bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800', 'border-yellow-500', 'border-blue-400', 'border-green-500');
                            textoAlertaEl.classList.remove('text-yellow-700', 'text-blue-700', 'text-green-700');

                            // Remover SVG existente se houver
                            const existingSvg = alertaPeriodoEl.querySelector('h3 svg'); // Seleciona o SVG dentro do h3
                            if (existingSvg) {
                                existingSvg.remove();
                            }

                            if (progressoPercentual >= 100) {
                                // Período completo
                                alertaPeriodoEl.classList.add('border-green-500');
                                textoAlertaEl.classList.add('text-green-700');
                                textoAlertaEl.textContent = 'Período aquisitivo completo!';
                                // Adicionar ícone diretamente antes do texto (ou ajustar conforme estrutura)
                                const svgIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                                svgIcon.classList.add("h-6", "w-6", "mr-2", "text-green-500");
                                svgIcon.setAttribute("fill", "none");
                                svgIcon.setAttribute("viewBox", "0 0 24 24");
                                svgIcon.setAttribute("stroke", "currentColor");
                                svgIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>`;
                                alertaPeriodoEl.querySelector('h3').prepend(svgIcon);


                            } else if (diasRestantes <= 30) {
                                // Faltando 1 mês ou menos
                                alertaPeriodoEl.classList.add('border-yellow-500');
                                textoAlertaEl.classList.add('text-yellow-700');
                                textoAlertaEl.textContent = `Faltam apenas ${diasRestantes} dias para completar o período aquisitivo!`;
                                const svgIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                                svgIcon.classList.add("h-6", "w-6", "mr-2", "text-yellow-500");
                                svgIcon.setAttribute("fill", "none");
                                svgIcon.setAttribute("viewBox", "0 0 24 24");
                                svgIcon.setAttribute("stroke", "currentColor");
                                svgIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>`;
                                alertaPeriodoEl.querySelector('h3').prepend(svgIcon);

                            } else {
                                // Período em andamento
                                alertaPeriodoEl.classList.add('border-blue-400');
                                textoAlertaEl.classList.add('text-blue-700');
                                textoAlertaEl.textContent = `Faltam ${diasRestantes} dias para completar o período aquisitivo`;
                                const svgIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                                svgIcon.classList.add("h-6", "w-6", "mr-2", "text-blue-500");
                                svgIcon.setAttribute("fill", "none");
                                svgIcon.setAttribute("viewBox", "0 0 24 24");
                                svgIcon.setAttribute("stroke", "currentColor");
                                svgIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>`;
                                alertaPeriodoEl.querySelector('h3').prepend(svgIcon);
                            }
                        }
                    });
                </script>

                <!-- Modais para LP -->
                {% include 'modals/_novo_lp_modal.html' with cadastro=lp.cadastro initial_data=initial_data %}
                {% include 'modals/_editar_concessao_lp_modal.html' with lp=lp %}
                {% include 'modals/_concluir_lp_modal.html' with lp=lp %}
                {% include 'modals/_editar_dias_desconto_lp_modal.html' with lp=lp %}
                {% include 'modals/confirmar_sipa_lp_modal.html' with lp=lp %}
                {% include 'modals/_excluir_lp_modal.html' with lp=lp %}

                <!-- Seção de Detalhes da Concessão -->
                <fieldset class="bg-gray-50 mb-4 rounded-2xl shadow-lg p-6 border border-gray-300">
                    <div class="border border-gray-300 rounded-xl p-6 mb-6 bg-gray-50 shadow-sm {% if lp.data_concessao_lp or lp.bol_g_pm_lp or lp.data_publicacao_lp %}border-green-500{% else %}border-gray-300{% endif %}">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Detalhes da Concessão
                            </h3>
                            
                            <!-- Botão condicional -->
                            <div>
                                <div class="flex justify-end">
                                    {% if lp.data_concessao_lp or lp.bol_g_pm_lp or lp.data_publicacao_lp %}
                                        <button class="px-4 py-2 bg-green-500 text-white rounded-md shadow-sm cursor-not-allowed flex items-center gap-2" disabled>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                            Concessão Registrada
                                        </button>
                                    {% else %}
                                        <button onclick="openEditarConcessaoLPModal('{{ lp.pk }}', '{{ lp.data_concessao_lp|date:'Y-m-d' }}', '{{ lp.bol_g_pm_lp|default:'' }}', '{{ lp.data_publicacao_lp|date:'Y-m-d' }}')"
                                                class="px-4 py-2 bg-blue-600 text-white rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                            Inserir Concessão
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Card 1 - Data de Concessão -->
                            <div class="flex flex-col p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4
                                {% if lp.data_concessao_lp %}border-green-500
                                {% else %}border-gray-300{% endif %}">
                                <span class="text-sm text-gray-700">Data de Concessão</span>
                                <p class="text-xl text-blue-900 mt-2">
                                    {% if lp.data_concessao_lp %}
                                        {{ lp.data_concessao_lp|date:"d/m/Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </p>
                                {% if lp.data_concessao_lp %}
                                <span class="mt-2 text-xs text-green-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Concedido
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- Card 2 - BOL G Pm Concessão -->
                            <div class="flex flex-col p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4
                                {% if lp.bol_g_pm_lp %}border-blue-500
                                {% else %}border-gray-300{% endif %}">
                                <span class="text-sm text-gray-700">BOL G Pm Concessão</span>
                                <p class="text-xl text-blue-900 mt-2">
                                    {{ lp.bol_g_pm_lp|default:"-" }}
                                </p>
                                {% if lp.bol_g_pm_lp %}
                                <span class="mt-2 text-xs text-blue-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Publicado
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- Card 3 - Data Publicação -->
                            <div class="flex flex-col p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4
                                {% if lp.data_publicacao_lp %}border-purple-500
                                {% else %}border-gray-300{% endif %}">
                                <span class="text-sm text-gray-700">Data Publicação</span>
                                <p class="text-xl text-blue-900 mt-2">
                                    {% if lp.data_publicacao_lp %}
                                        {{ lp.data_publicacao_lp|date:"d/m/Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </p>
                                {% if lp.data_publicacao_lp %}
                                <span class="mt-2 text-xs text-purple-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                                    </svg>
                                    Registrado
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </fieldset>

                <!-- Metadados (Criação/Atualização) -->
                <fieldset class="bg-gray-50 mb-4 rounded-2xl shadow-lg p-6 border border-green-300">
                    <div class="border border-green-300 rounded-xl p-6 mb-6 bg-gray-50 shadow-sm">
                        <!-- Título da seção -->
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Metadados do Processo
                            </h3>
                        </div>

<!-- Cards de Criação/Atualização -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Card 1 - Criado em -->
    <div class="flex flex-col p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4 border-blue-500">
        <span class="text-sm text-gray-700">Criado em</span>
        <p class="text-xl text-blue-900 mt-2">
            {{ lp.data_cadastro|date:"d/m/Y H:i" }}
        </p>
        <div class="mt-2 text-xs text-gray-600 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            Por: 
            {% if lp.user_created %}
                {% with militar_cadastro=lp.user_created.cadastros.last %}
                    {% if militar_cadastro %}
                        <span class="font-medium">
                            {{ militar_cadastro.ultima_promocao.posto_grad }}
                            {{ militar_cadastro.re }}-{{ militar_cadastro.dig }}
                            {{ lp.user_created.last_name }}
                        </span>
                    {% else %}
                        {% firstof lp.user_created.get_full_name lp.user_created.username %}
                    {% endif %}
                {% endwith %}
            {% else %}
                Usuário Desconhecido
            {% endif %}
        </div>
    </div>
    
    <!-- Card 2 - Atualizado em -->
    <div class="flex flex-col p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 border-l-4 border-blue-500">
        <span class="text-sm text-gray-700">Atualizado em</span>
        <p class="text-xl text-blue-900 mt-2">
            {{ lp.data_atualizacao|date:"d/m/Y H:i" }}
        </p>
        <div class="mt-2 text-xs text-gray-600 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            Por: 
            {% if lp.user_updated %}
                {% with militar_cadastro=lp.user_updated.cadastros.last %}
                    {% if militar_cadastro %}
                        <span class="font-medium">
                            {{ militar_cadastro.ultima_promocao.posto_grad }}
                            {{ militar_cadastro.re }}-{{ militar_cadastro.dig }}
                            {{ lp.user_updated.last_name }}
                        </span>
                    {% else %}
                        {% firstof lp.user_updated.get_full_name lp.user_updated.username %}
                    {% endif %}
                {% endwith %}
            {% else %}
                Usuário Desconhecido
            {% endif %}
        </div>
    </div>
</div>

<!-- Seção de Conclusão (se aplicável) -->
{% if lp.status_lp == 'publicado' %}
<div class="mt-6 p-6 bg-green-100 rounded-xl border border-green-300 shadow-sm">
    <h3 class="text-xl font-semibold text-green-900 mb-4 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Processo Concluído
    </h3>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
            <span class="text-sm text-gray-700">Data de Concessão</span>
            <p class="text-xl text-green-900 mt-1">
                {% if lp.data_concessao_lp %}
                    {{ lp.data_concessao_lp|date:"d/m/Y" }}
                {% else %}
                    Não informada
                {% endif %}
            </p>
        </div>
        
        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
            <span class="text-sm text-gray-700">Concluído por</span>
            <p class="text-lg text-green-900 mt-1">
                {% if lp.usuario_conclusao %}
                    {% with militar_cadastro=lp.usuario_conclusao.cadastros.last %}
                        {% if militar_cadastro %}
                            <span class="font-medium">
                                {{ militar_cadastro.ultima_promocao.posto_grad }}
                                {{ militar_cadastro.re }}-{{ militar_cadastro.dig }}
                                {{ lp.usuario_conclusao.last_name }}
                            </span>
                        {% else %}
                            {% firstof lp.usuario_conclusao.get_full_name lp.usuario_conclusao.username %}
                        {% endif %}
                    {% endwith %}
                {% else %}
                    Sistema
                {% endif %}
            </p>
        </div>
        
        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
            <span class="text-sm text-gray-700">Data de Conclusão</span>
            <p class="text-xl text-green-900 mt-1">
                {% if lp.data_conclusao %}
                    {{ lp.data_conclusao|date:"d/m/Y H:i" }}
                {% else %}
                    Não registrada
                {% endif %}
            </p>
        </div>
    </div>
</div>
{% comment %}
    backend/lp/templates/detalhar_lp.html
    Este é o template principal que inclui os modais e o JavaScript.
{% endcomment %}

{% endif %}


<div class="flex justify-end mt-8">
    <button onclick="openConcluirLPModal('{{ lp.pk }}')"
            class="px-6 py-3 {% if lp.status_lp == 'concluido' %}bg-gray-100 text-green-600 border-2 border-green-500 cursor-not-allowed{% else %}bg-indigo-700 text-white hover:bg-indigo-800{% endif %}
                    rounded-lg transition-all duration-200 font-medium shadow-md
                    flex items-center gap-2"
                    {% if lp.status_lp == 'concluido' %}disabled{% endif %}>
        {% if lp.status_lp == 'concluido' %}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Processo Concluído
        {% else %}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            Concluir Processo
        {% endif %}
    </button>
</div>

{# Inclua os modais. ATENÇÃO: Eles devem conter APENAS HTML agora! #}
{% include 'modals/_novo_lp_modal.html' with cadastro=lp.cadastro lp=lp data_fim_periodo_lp=data_fim_periodo_lp %}
{% include 'modals/_concluir_lp_modal.html' %}


<script>
document.addEventListener('DOMContentLoaded', function() {
    // =========================================================
    // VARIÁVEIS E FUNÇÕES GLOBAIS AUXILIARES (PARA ALERTS E LIMPEZA DE FORMULÁRIO)
    // =========================================================

    // Função para exibir alertas (toasts)
    function showAlert(type, title, message) {
        hideAllAlerts(); 
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} fixed top-4 right-4 z-[2000] p-4 rounded-md shadow-lg max-w-md transition-all duration-300 transform translate-y-[-20px] opacity-0`;
        alertDiv.style.backgroundColor = type === 'success' ? '#d1fae5' : '#fee2e2';
        alertDiv.style.color = type === 'success' ? '#065f46' : '#b91c1c';
        alertDiv.innerHTML = `
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    ${type === 'success' ? 
                        '<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : 
                        '<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'}
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium">${title}</h3>
                    <div class="mt-1 text-sm">${message}</div>
                </div>
                <button class="ml-auto close-alert text-xl leading-none">&times;</button>
            </div>
        `;
        document.body.appendChild(alertDiv);
        
        void alertDiv.offsetWidth; // Força o reflow para garantir a transição
        
        alertDiv.style.opacity = '1';
        alertDiv.style.transform = 'translateY(0)';
        
        setTimeout(() => {
            alertDiv.style.opacity = '0';
            alertDiv.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                alertDiv.remove();
            }, 300);
        }, 5000); 
        
        alertDiv.querySelector('.close-alert').addEventListener('click', () => {
            alertDiv.style.opacity = '0';
            alertDiv.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                alertDiv.remove();
            }, 300);
        });
    }
    
    // Função para esconder todos os alertas
    function hideAllAlerts() {
        document.querySelectorAll('.alert').forEach(alert => {
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                alert.remove();
            }, 300);
        });
    }

    // Função para limpar mensagens de erro e bordas de inputs
    function clearFormErrors(formElement) {
        formElement.querySelectorAll('[id^="error_"]').forEach(el => el.textContent = '');
        formElement.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
    }

    // =========================================================
    // LÓGICA DO MODAL DE CONCLUIR LP
    // =========================================================
    const concluirLPModalEl = document.getElementById('concluirLPModal');
    const formConcluirLP = concluirLPModalEl.querySelector('form');
    const submitConcluirLPBtn = document.getElementById('submitConcluirLP');
    const normalStateConcluirLP = document.getElementById('normalStateConcluir');
    const loadingStateConcluirLP = document.getElementById('loadingStateConcluir');
    const passwordInputConcluir = document.getElementById('passwordInputConcluir');
    const passwordErrorConcluir = document.getElementById('passwordErrorConcluir');
    const dataConclusaoInput = document.getElementById('dataConclusaoInput');
    const dataConclusaoError = document.getElementById('dataConclusaoError');

    let isSubmittingConcluirLP = false; // Flag para prevenir duplicação

    // Função para abrir o modal de Concluir LP
    window.openConcluirLPModal = function(lpPk) {
        formConcluirLP.action = `{% url 'lp:concluir_lp' pk=lp.pk %}`.replace('{{ lp.pk }}', lpPk);
        formConcluirLP.reset(); 
        clearFormErrors(formConcluirLP); 
        concluirLPModalEl.classList.remove('hidden');
        setTimeout(() => {
            concluirLPModalEl.querySelector('div.transform').classList.remove('scale-95', 'opacity-0');
            concluirLPModalEl.querySelector('div.transform').classList.add('scale-100', 'opacity-100');
        }, 10);
    };

    // Função para fechar o modal de Concluir LP
    window.closeConcluirLPModal = function() {
        concluirLPModalEl.querySelector('div.transform').classList.remove('scale-100', 'opacity-100');
        concluirLPModalEl.querySelector('div.transform').classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            concluirLPModalEl.classList.add('hidden');
            isSubmittingConcluirLP = false; 
        }, 300);
    };

    // Event listener para a submissão do formulário de conclusão da LP
    formConcluirLP.addEventListener('submit', async (e) => {
        e.preventDefault(); 
        
        if (isSubmittingConcluirLP) {
            console.log("Submissão de Concluir LP já em progresso, ignorando clique duplicado.");
            return; 
        }
        isSubmittingConcluirLP = true;

        clearFormErrors(formConcluirLP); 

        normalStateConcluirLP.classList.add('hidden');
        loadingStateConcluirLP.classList.remove('hidden');
        submitConcluirLPBtn.disabled = true;

        try {
            const formData = new FormData(formConcluirLP);
            
            const response = await fetch(formConcluirLP.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formConcluirLP.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();
            
            if (response.ok && data.alert && data.alert.type === 'success') {
                closeConcluirLPModal(); 
                showAlert(data.alert.type, data.alert.title, data.alert.message);
                
                // Abre o modal de nova LP após a animação de fechamento terminar
                const cadastroId = '{{ lp.cadastro.id }}'; 
                setTimeout(() => {
                    openNovoLPModal(cadastroId); 
                }, 350); 

            } else {
                showAlert(data.alert.type, data.alert.title, data.alert.message);
                if (data.errors) {
                    for (const field in data.errors) {
                        const errorDiv = document.getElementById(`${field}Error`);
                        const inputField = document.getElementById(field);
                        if (errorDiv) {
                            errorDiv.textContent = data.errors[field];
                        }
                        if (inputField) {
                            inputField.classList.add('border-red-500');
                        }
                    }
                } else if (data.alert.message && (data.alert.message.includes('Senha incorreta'))) {
                    passwordErrorConcluir.textContent = data.alert.message;
                    passwordErrorConcluir.classList.remove('hidden'); // Garante que a mensagem de erro da senha é visível
                    passwordInputConcluir.classList.add('border-red-500');
                }
            }
        } catch (error) {
            console.error('Erro na requisição AJAX para concluir LP:', error);
            showAlert('error', 'Erro!', 'Erro na comunicação com o servidor. Tente novamente.');
        } finally {
            normalStateConcluirLP.classList.remove('hidden');
            loadingStateConcluirLP.classList.add('hidden');
            submitConcluirLPBtn.disabled = false;
            isSubmittingConcluirLP = false; 
        }
    });

    // =========================================================
    // LÓGICA DO MODAL DE NOVO LP
    // =========================================================
    const novoLPModal = document.getElementById('novoLPModal');
    const formNovoLP = document.getElementById('formNovoLP');
    const submitNovoLP = formNovoLP.querySelector('#submitNovoLP');
    const normalStateNovoLP = submitNovoLP.querySelector('#normalState');
    const loadingStateNovoLP = submitNovoLP.querySelector('#loadingState');

    let isSubmittingNovoLP = false; 

    // Função para abrir o modal de Nova LP
    window.openNovoLPModal = function(cadastroId) {
        formNovoLP.reset(); 
        clearFormErrors(formNovoLP); 
        
        const cadastroIdInput = formNovoLP.querySelector('input[name="cadastro_id"]');
        if (cadastroIdInput) {
            cadastroIdInput.value = cadastroId;
        } else {
            console.warn("Input 'cadastro_id' não encontrado no formulário da Nova LP.");
        }
        
        // Inicializa os campos de data e número com os valores do Django
        const dataUltimoLpInput = document.getElementById('data_ultimo_lp');
        const numeroLpInput = document.getElementById('numero_lp');

        // Assegura que os valores iniciais dos campos data_ultimo_lp e numero_lp são definidos no JS
        // para que updateCalculatedFields() funcione corretamente na abertura.
        // Estes valores vêm do contexto do Django no HTML do modal.
        // lp.numero_prox_lp e lp.data_concessao_lp/data_fim_periodo_lp são passados via include no Django.
        dataUltimoLpInput.value = dataUltimoLpInput.defaultValue;
        numeroLpInput.value = numeroLpInput.defaultValue;

        updateCalculatedFields(); // Atualiza campos calculados ao abrir o modal (data e número)

        novoLPModal.classList.remove('hidden');
        setTimeout(() => {
            novoLPModal.querySelector('div.transition-all').classList.remove('scale-95', 'opacity-0');
            novoLPModal.querySelector('div.transition-all').classList.add('scale-100', 'opacity-100');
        }, 10);
    };

    // Função para fechar o modal de Nova LP
    window.closeNovoLPModal = function() {
        novoLPModal.querySelector('div.transition-all').classList.remove('scale-100', 'opacity-100');
        novoLPModal.querySelector('div.transition-all').classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            novoLPModal.classList.add('hidden');
            isSubmittingNovoLP = false; 
        }, 300);
    };

    // Event listener para a submissão do formulário de Nova LP
    formNovoLP.addEventListener('submit', async function(e) {
        e.preventDefault(); 
        
        if (isSubmittingNovoLP) {
            console.log("Submissão de Nova LP já em progresso, ignorando clique duplicado.");
            return; 
        }
        isSubmittingNovoLP = true;
        
        clearFormErrors(formNovoLP); 

        normalStateNovoLP.classList.add('hidden');
        loadingStateNovoLP.classList.remove('hidden');
        submitNovoLP.disabled = true;
        
        try {
            const formData = new FormData(this);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            });
            
            const data = await response.json();
            
            if (response.ok && data.alert && data.alert.type === 'success') {
                showAlert(data.alert.type, data.alert.title, data.alert.message);
                closeNovoLPModal();
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    location.reload(); // Recarrega a página para mostrar a nova LP
                }
            } else {
                showAlert(data.alert.type, data.alert.title, data.alert.message);
                if (data.errors) {
                    for (const field in data.errors) {
                        const errorDiv = document.getElementById(`error_${field}`);
                        const inputField = document.getElementById(field);
                        if (errorDiv) {
                            errorDiv.textContent = data.errors[field];
                        }
                        if (inputField) {
                            inputField.classList.add('border-red-500');
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Erro na requisição AJAX para criar Nova LP:', error);
            showAlert('error', 'Erro!', 'Erro na comunicação com o servidor. Tente novamente.');
        } finally {
            normalStateNovoLP.classList.remove('hidden');
            loadingStateNovoLP.classList.add('hidden');
            submitNovoLP.disabled = false;
            isSubmittingNovoLP = false; 
        }
    });

    // =========================================================
    // FUNÇÕES DE CÁLCULO E LISTENERS DE INPUT PARA NOVO LP
    // =========================================================

    // Função para atualizar os campos calculados no modal de Nova LP
    function updateCalculatedFields() {
        const dataUltimoLpInput = document.getElementById('data_ultimo_lp'); 
        const numeroLpInput = document.getElementById('numero_lp'); 

        const previsaoNumeroProxLpOutput = document.getElementById('previsao_numero_prox_lp');
        const proximoLpOutput = document.getElementById('proximo_lp_output');
        const mesProximoLpOutput = document.getElementById('mes_proximo_lp_output');
        const anoProximoLpOutput = document.getElementById('ano_proximo_lp_output');

        let dataUltimoLp = dataUltimoLpInput.value;
        let numeroLP = parseInt(numeroLpInput.value);

        if (dataUltimoLp && !isNaN(numeroLP)) {
            try {
                const dataBaseCalculo = new Date(dataUltimoLp + 'T00:00:00'); 
                const proximoLpDate = new Date(dataBaseCalculo);
                proximoLpDate.setFullYear(proximoLpDate.getFullYear() + 5);

                if (previsaoNumeroProxLpOutput) {
                    previsaoNumeroProxLpOutput.value = numeroLP + 1;
                }
                
                if (proximoLpOutput) {
                    proximoLpOutput.value = proximoLpDate.toISOString().split('T')[0];
                }
                
                if (mesProximoLpOutput) {
                    mesProximoLpOutput.value = String(proximoLpDate.getMonth() + 1).padStart(2, '0');
                }
                if (anoProximoLpOutput) {
                    anoProximoLpOutput.value = proximoLpDate.getFullYear();
                }

            } catch (e) {
                console.error("Erro nos cálculos do front-end:", e);
                if (previsaoNumeroProxLpOutput) previsaoNumeroProxLpOutput.value = 'Erro';
                if (proximoLpOutput) proximoLpOutput.value = '';
                if (mesProximoLpOutput) mesProximoLpOutput.value = 'Erro';
                if (anoProximoLpOutput) anoProximoLpOutput.value = 'Erro';
            }
        } else {
            if (previsaoNumeroProxLpOutput) previsaoNumeroProxLpOutput.value = 'N/A';
            if (proximoLpOutput) proximoLpOutput.value = '';
            if (mesProximoLpOutput) mesProximoLpOutput.value = 'N/A';
            if (anoProximoLpOutput) anoProximoLpOutput.value = 'N/A';
        }
    }
    
    // Adicionar listeners para os campos que acionam o cálculo
    const dataUltimoLpInputNovo = document.getElementById('data_ultimo_lp');
    const numeroLpInputNovo = document.getElementById('numero_lp');

    if (dataUltimoLpInputNovo) {
        dataUltimoLpInputNovo.addEventListener('change', updateCalculatedFields);
    }
    if (numeroLpInputNovo) {
        numeroLpInputNovo.addEventListener('change', updateCalculatedFields);
    }
    
    // Chame updateCalculatedFields() na carga inicial para preencher os campos se houver dados preexistentes
    updateCalculatedFields();
});
</script>
</fieldset>
</div> 

{# Script de controle (só carrega quando status é "concluido") #}
{% if lp.status_lp == "concluido" %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButton = document.getElementById('toggleLpDetails');
        const lpDetailsContent = document.getElementById('lpDetailsContent');
        const toggleText = document.getElementById('toggleText');

        // Configuração inicial
        if (lpDetailsContent.style.display === 'none') {
            toggleButton.setAttribute('aria-expanded', 'false');
            toggleText.textContent = 'Clique aqui para mostrar detalhes da Concessão';
        } else {
            toggleButton.setAttribute('aria-expanded', 'true');
            toggleText.textContent = 'Esconder Detalhes da Licença Prêmio';
        }

        toggleButton.addEventListener('click', function() {
            const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
            
            if (isExpanded) {
                // Ocultar conteúdo
                lpDetailsContent.style.maxHeight = '0';
                lpDetailsContent.style.opacity = '0';
                toggleButton.setAttribute('aria-expanded', 'false');
                toggleText.textContent = 'Mostrar Detalhes da Licença Prêmio';
            } else {
                // Mostrar conteúdo
                lpDetailsContent.style.maxHeight = lpDetailsContent.scrollHeight + 'px';
                lpDetailsContent.style.opacity = '1';
                toggleButton.setAttribute('aria-expanded', 'true');
                toggleText.textContent = 'Esconder Detalhes da Licença Prêmio';
            }
        });
    });
</script>
{% endif %}

                <!-- Próxima LP -->
                {% if lp.proximo_lp and lp.numero_prox_lp <= 8 %}
                <fieldset class="bg-gray-50 mb-4 rounded-2xl shadow-lg p-6 border border-gray-300">
                    <div class="p-6 bg-blue-50 rounded-xl border border-blue-200 shadow-sm">
                        <h3 class="text-xl font-semibold text-blue-800 mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Próxima LP (Previsão)
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="p-4 bg-white rounded-lg border border-blue-200">
                                <span class="text-sm text-gray-700">Número da Próxima LP</span>
                                <p class="text-xl text-blue-900 mt-1">
                                    {{ lp.numero_prox_lp }}º LP
                                </p>
                            </div>
                            
                            <div class="p-4 bg-white rounded-lg border border-blue-200">
                                <span class="text-sm text-gray-700">Previsão de Fechamento</span>
                                <p class="text-xl text-blue-900 mt-1">
                                    {{ lp.proximo_lp|date:"d/m/Y" }}
                                </p>
                            </div>
                            
                            <div class="p-4 bg-white rounded-lg border border-blue-200">
                                <span class="text-sm text-gray-700">Mês/Ano do Próximo Período</span>
                                <p class="text-xl text-blue-900 mt-1">
                                    {{ lp.proximo_lp|date:"m/Y" }}
                                </p>
                            </div>
                        </div>
                    </div>
                </fieldset>
                {% endif %}

                <!-- Histórico -->
                <fieldset class="bg-gray-50 mb-4 rounded-2xl shadow-lg p-6 border border-gray-300">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Histórico da LP</h2>
                    <div class="overflow-x-auto rounded-lg border border-gray-400 shadow-sm">
                        <table class="min-w-full divide-y divide-gray-400">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-blue-700 uppercase">Data Alteração</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-blue-700 uppercase">Usuário</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-blue-700 uppercase">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-blue-700 uppercase">Dados Alterados</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-300">
                               {% for hist in historico_lp %}
                                <tr class="hover:bg-blue-50">
                                    <td class="px-4 py-3 text-sm text-blue-800 font-medium">
                                        {{ hist.data_alteracao|date:"d/m/Y H:i" }}
                                    </td>
        
                                    <td class="px-4 py-3 text-sm text-gray-800">
           {% with militar_cadastro=request.user.cadastros.last %}
                                    {% if militar_cadastro %}
                                        <div class="font-medium">
                                            {{ militar_cadastro.ultima_promocao.posto_grad }}
                                            {{ militar_cadastro.re }}-{{ militar_cadastro.dig }}
                                            {{ request.user.last_name }}
                                        </div>
                                        <div class="text-gray-500">{{ militar_cadastro.cpf }}</div>
                                    {% else %}
                                        <div class="font-medium">Dados do usuário não disponíveis</div>
                                    {% endif %}
                                {% endwith %}
                                    </td>
        
                                    <td class="px-4 py-3 text-sm font-medium
                                        {% if hist.status_lp == 'concluido' %}text-green-700
                                        {% elif hist.status_lp == 'publicado' %}text-blue-700
                                        {% else %}text-yellow-700{% endif %}">
                                        {{ hist.get_status_lp_display }}
                                    </td>
        
                                    <td class="px-4 py-3 text-sm text-gray-800">
                                        {% if hist.observacoes_historico %}{{ hist.observacoes_historico }}{% else %}-{% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="px-4 py-3 text-sm text-center text-gray-600">
                                        Nenhum registro histórico encontrado
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </fieldset>

<!-- Histórico de LPs Concluídas -->
<fieldset class="bg-gray-50 mb-4 rounded-2xl shadow-lg p-6 border border-gray-300">
    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Histórico de LPs Concluídas</h2>
    <div class="overflow-x-auto rounded-lg border border-gray-400 shadow-sm">
        <table class="min-w-full divide-y divide-gray-400">
            <thead class="bg-blue-100">
                <tr>
                    <th class="px-4 py-3 text-center text-xs font-medium text-blue-700 uppercase">LP</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-blue-700 uppercase">Concessão</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-blue-700 uppercase">Publicação<br> (Bol G PM)</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-blue-700 uppercase">Data Publicação</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-blue-700 uppercase">Disponíveis</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-blue-700 uppercase">Utilizados</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-blue-700 uppercase">Usuário Alteração</th> {# Ajustado o nome do cabeçalho #}
                    <th class="px-4 py-3 text-center text-xs font-medium text-blue-700 uppercase">Status</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-blue-700 uppercase">Ações</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-300">
                {% for registro in historico_cadastro %}
                <tr class="hover:bg-blue-50">
                    {# Coluna LP - Estilizada com background colorido e texto claro #}
                    <td class="px-4 py-3 text-sm font-bold text-center">
                        <span class="inline-flex items-center justify-center h-8 w-8 rounded-full text-white
                            {% if registro.numero_lp == 1 %}bg-blue-600
                            {% elif registro.numero_lp == 2 %}bg-green-600
                            {% elif registro.numero_lp == 3 %}bg-purple-600
                            {% elif registro.numero_lp == 4 %}bg-red-600
                            {% elif registro.numero_lp == 5 %}bg-yellow-600
                            {% elif registro.numero_lp == 6 %}bg-indigo-600
                            {% elif registro.numero_lp == 7 %}bg-pink-600
                            {% elif registro.numero_lp == 8 %}bg-teal-600
                            {% else %}bg-gray-400{% endif %}">
                            {{ registro.numero_lp }}
                        </span>
                    </td>

                    {# Coluna Concessão #}
                    <td class="px-4 py-3 text-sm text-gray-800 text-center">
                        {{ registro.data_concessao_lp|date:"d/m/Y"|default:"N/A" }}
                    </td>

                    {# Coluna Publicação (BOL) #}
                    <td class="px-4 py-3 text-sm text-gray-800 text-center">
                        {{ registro.bol_g_pm_lp|default:"N/A" }}
                    </td>

                    {# Coluna Data Publicação #}
                    <td class="px-4 py-3 text-sm text-gray-800 text-center">
                        {{ registro.data_publicacao_lp|date:"d/m/Y"|default:"N/A" }}
                    </td>

                    {# Coluna Disponíveis - Com visual de pílula #}
                    <td class="px-4 py-3 text-center">
                        {% if registro.lp.previsao_associada %}
                            <span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-sm font-semibold text-white
                                {% if registro.lp.previsao_associada.dias_disponiveis == 0 %}bg-red-500
                                {% else %}bg-green-500{% endif %}">
                                {{ registro.lp.previsao_associada.dias_disponiveis|default:"0" }} dias
                            </span>
                        {% else %}
                            <span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-gray-300 text-gray-700">
                                N/A
                            </span>
                        {% endif %}
                    </td>

                    {# Coluna Utilizados - Com visual de pílula #}
                    <td class="px-4 py-3 text-center">
                        {% if registro.lp.previsao_associada %}
                            <span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-sm font-semibold text-white
                                {% if registro.lp.previsao_associada.dias_utilizados == 90 %}bg-red-500
                                {% else %}bg-blue-500{% endif %}"> {# Usei blue para 'utilizados' que não chegou a 90, para diferenciar #}
                                {{ registro.lp.previsao_associada.dias_utilizados|default:"0" }} dias
                            </span>
                        {% else %}
                            <span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-gray-300 text-gray-700">
                                N/A
                            </span>
                        {% endif %}
                    </td>

                    {# Coluna Usuário Alteração (Original) #}
                    <td class="px-4 py-3 text-sm text-gray-800 text-center">
                        {% with militar=registro.usuario_alteracao.cadastros.last %}
                            {% if militar %}
                                <div class="font-medium">
                                    {{ militar.ultima_promocao.posto_grad }}
                                    {{ militar.re }}-{{ militar.dig }}
                                    {{ registro.usuario_alteracao.last_name }}
                                </div>
                                <div class="text-gray-500">{{ militar.cpf }}</div>
                            {% else %}
                                <div class="font-medium">
                                    {{ registro.usuario_alteracao.username|default:"Sistema" }}
                                </div>
                            {% endif %}
                        {% endwith %}
                    </td>

                    {# Coluna Status - Nova lógica baseada em Dias Disponíveis com estilo visual de pílula #}
                    <td class="px-4 py-3 text-center">
                        {% if registro.lp.previsao_associada and registro.lp.previsao_associada.dias_disponiveis != 0 %}
                            <span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-500 text-white">
                                Disponível
                            </span>
                        {% else %}
                            <span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-500 text-white">
                                Concluído
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-800 text-center">
                        {% if registro.lp %}
                            <a href="{% url 'lp:ver_lp' registro.lp.pk %}"
                            class="text-blue-600 hover:text-blue-800"
                            title="Ver detalhes da LP">
                                <i class="fas fa-eye"></i> {# Ícone de olho para "Ver" #}
                            </a>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    {# colspan ajustado para o novo número de colunas (9) #}
                    <td colspan="9" class="px-4 py-3 text-sm text-center text-gray-600">
                        Nenhuma LP concluída encontrada
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</fieldset>





                <!-- Botões Finais -->

<fieldset class="bg-gray-50 mb-4 rounded-2xl shadow-lg p-6 border border-gray-300">
    <div class="bg-blue-100 rounded-2xl shadow-2xl w-full p-8 transition-all duration-300 animate-fade-in">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex-1 space-y-2">
                <p class="text-xs text-blue-700 font-medium text-center md:text-left">
                    Sistema de Gestão de Licenças Prêmio - {{ current_year }}
                </p>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">


                <button onclick="openEditarLpModal('{{ lp.pk }}')"
                        class="flex-1 px-6 py-3.5 bg-gradient-to-r from-green-600 to-green-700 text-white
                                font-semibold rounded-xl shadow-sm hover:shadow-md
                                transition-all duration-200 hover:scale-[1.02]
                                flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                    Editar LP Completa
                </button>
            </div>
        </div>
    </div>
</fieldset>

            </div>
        </div>
    </div>


<!-- Incluir modais -->
{# Certifique-se de que esses templates de modal existam nos caminhos especificados #}
{% include "modals/_novo_lp_modal.html" with cadastro=lp.cadastro initial_data=initial_data %}
{% include 'modals/_editar_concessao_lp_modal.html' with lp=lp %}
{% include "modals/_concluir_lp_modal.html" with lp=lp %}
{% include "modals/_editar_dias_desconto_lp_modal.html" with lp=lp %}
{% include "modals/confirmar_sipa_lp_modal.html" with lp=lp %}
{% include "modals/_excluir_lp_modal.html" with lp=lp %}

{% include 'modals/_editar_lp_modal.html' %}

<script>
    // Garante que 'showAlert' está disponível antes de ser usada.
    // Esta função deve vir do seu 'modal_alerts.html' ou de um script global.
    if (typeof showAlert !== 'function') {
        window.showAlert = function(type, title, message) {
            console.log(`Alert (Type: ${type}, Title: ${title}): ${message}`);
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertIcon = document.getElementById('alert-icon');

            if (alertModal && alertTitle && alertMessage && alertIcon) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');

                let iconSvg = '';
                if (type === 'success') {
                    iconSvg = `<svg class="w-16 h-16 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                } else if (type === 'error') {
                    iconSvg = `<svg class="w-16 h-16 text-red-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                } else { // info/warning
                    iconSvg = `<svg class="w-16 h-16 text-blue-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                }
                alertIcon.innerHTML = iconSvg;

                setTimeout(() => {
                    alertModal.classList.add('hidden');
                }, 5000);
            } else {
                console.warn("Elemento de alerta global não encontrado. Certifique-se de que 'modal_alerts.html' está incluído.");
            }
        };
    }

    // --- FUNÇÕES GLOBAIS E LISTENERS DE DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', function() {
        // Lógica para carregar o modal de novo LP se o parâmetro showNovoLP estiver na URL
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('showNovoLP') && urlParams.has('cadastro_id')) {
            const cadastroId = urlParams.get('cadastro_id');
            if (typeof openNovoLPModal === 'function') {
                openNovoLPModal(cadastroId);
            } else {
                console.warn("openNovoLPModal function is not defined. Make sure _novo_lp_modal.html script is loaded.");
            }
            const newUrl = window.location.pathname + window.location.search.replace(/([?&])showNovoLP=true&cadastro_id=\d+/, '');
            history.replaceState({}, '', newUrl);
        }
        
        // --- Modal de Edição de Concessão de LP ---
        const editarConcessaoLpModal = document.getElementById('editarConcessaoLpModal');
        const formEditarConcessaoLP = document.getElementById('formEditarConcessaoLP');

        if (!editarConcessaoLpModal || !formEditarConcessaoLP) {
            console.error("Erro: Um ou mais elementos do modal de edição de concessão de LP não foram encontrados no DOM. Verifique os IDs.");
            // Não 'return' aqui se você tiver outros modais que dependam deste script!
            // return; 
        } else {
            const submitButtonEditar = formEditarConcessaoLP.querySelector('#submitEditarConcessaoLP');
            const normalStateEditar = submitButtonEditar.querySelector('#normalStateEditarConcessao');
            const loadingStateEditar = submitButtonEditar.querySelector('#loadingStateEditarConcessao');

            window.openEditarConcessaoLPModal = function(lpId, dataConcessao, bolGpm, dataPublicacao) {
                formEditarConcessaoLP.action = `/lp/editar_concessao_lp/${lpId}/`;
                
                const dataConcessaoInput = document.getElementById('data_concessao_lp_modal');
                const bolGpmInput = document.getElementById('bol_g_pm_lp_modal');
                const dataPublicacaoInput = document.getElementById('data_publicacao_lp_modal');

                if (dataConcessaoInput) dataConcessaoInput.value = dataConcessao || '';
                if (bolGpmInput) bolGpmInput.value = bolGpm || '';
                if (dataPublicacaoInput) dataPublicacaoInput.value = dataPublicacao || '';
                
                editarConcessaoLpModal.classList.remove('hidden');
                setTimeout(() => {
                    editarConcessaoLpModal.firstElementChild.classList.remove('scale-95', 'opacity-0');
                    editarConcessaoLpModal.firstElementChild.classList.add('scale-100', 'opacity-100');
                }, 10);
            };

            window.closeEditarConcessaoLPModal = function() {
                editarConcessaoLpModal.firstElementChild.classList.remove('scale-100', 'opacity-100');
                editarConcessaoLpModal.firstElementChild.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    editarConcessaoLpModal.classList.add('hidden');
                    const dataConcessaoError = document.getElementById('dataConcessaoLPError');
                    const bolGpmError = document.getElementById('bolGPmLPError');
                    const dataPublicacaoError = document.getElementById('dataPublicacaoLPError');

                    if (dataConcessaoError) dataConcessaoError.classList.add('hidden');
                    if (bolGpmError) bolGpmError.classList.add('hidden');
                    if (dataPublicacaoError) dataPublicacaoError.classList.add('hidden');
                }, 300);
            };

            formEditarConcessaoLP.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                normalStateEditar.classList.add('hidden');
                loadingStateEditar.classList.remove('hidden');
                submitButtonEditar.disabled = true;
                
                const dataConcessaoError = document.getElementById('dataConcessaoLPError');
                const bolGpmError = document.getElementById('bolGPmLPError');
                const dataPublicacaoError = document.getElementById('dataPublicacaoLPError');

                if (dataConcessaoError) dataConcessaoError.classList.add('hidden');
                if (bolGpmError) bolGpmError.classList.add('hidden');
                if (dataPublicacaoError) dataPublicacaoError.classList.add('hidden');

                try {
                    const formData = new FormData(this);
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.alert && data.alert.type === 'success') {
                        if (typeof showAlert === 'function') {
                            showAlert(data.alert.type, data.alert.title, data.alert.message);
                        } else {
                            console.warn("showAlert function is not defined globally.");
                        }
                        closeEditarConcessaoLPModal();
                        if (data.reload_page) {
                            location.reload(); 
                        }
                    } else if (data.alert && data.alert.type === 'error') {
                        if (typeof showAlert === 'function') {
                            showAlert(data.alert.type, data.alert.title, data.alert.message);
                        } else {
                            console.warn("showAlert function is not defined globally.");
                        }
                        if (data.errors) {
                            if (data.errors.data_concessao_lp) { 
                                if (dataConcessaoError) {
                                    dataConcessaoError.textContent = data.errors.data_concessao_lp;
                                    dataConcessaoError.classList.remove('hidden');
                                }
                            }
                            if (data.errors.data_publicacao_lp) {
                                if (dataPublicacaoError) {
                                    dataPublicacaoError.textContent = data.errors.data_publicacao_lp;
                                    dataPublicacaoError.classList.remove('hidden');
                                }
                            }
                            if (data.errors.bol_g_pm_lp) {
                                if (bolGpmError) {
                                    bolGpmError.textContent = data.errors.bol_g_pm_lp;
                                    bolGpmError.classList.remove('hidden');
                                }
                            }
                        }
                    } else {
                        if (typeof showAlert === 'function') {
                            showAlert('error', 'Erro Desconhecido!', 'Ocorreu um erro inesperado.');
                        } else {
                            console.warn("showAlert function is not defined globally.");
                        }
                    }
                } catch (error) {
                    console.error('Erro na requisição:', error);
                    if (typeof showAlert === 'function') {
                        showAlert('error', 'Erro!', 'Erro na comunicação com o servidor. Tente novamente.');
                    } else {
                        console.warn("showAlert function is not defined globally.");
                    }
                } finally {
                    normalStateEditar.classList.remove('hidden');
                    loadingStateEditar.classList.add('hidden');
                    submitButtonEditar.disabled = false;
                }
            });
        }
        
        // --- Modal de Conclusão de LP ---
        const concluirLPModal = document.getElementById('concluirLPModal');
        const formConcluirLP = document.getElementById('formConcluirLP');

        if (!concluirLPModal || !formConcluirLP) {
            console.error("Erro: Um ou mais elementos do modal de conclusão de LP não foram encontrados no DOM. Verifique os IDs.");
        } else {
            const submitConcluirLPButton = formConcluirLP.querySelector('#submitConcluirLP');
            const normalStateConcluir = submitConcluirLPButton.querySelector('#normalStateConcluir');
            const loadingStateConcluir = submitConcluirLPButton.querySelector('#loadingStateConcluir');
            const passwordErrorConcluir = document.getElementById('passwordErrorConcluir');
            const dataConclusaoInput = document.getElementById('dataConclusaoInput');


            window.openConcluirLPModal = function(lpId) {
                formConcluirLP.action = `/lp/${lpId}/concluir/`; // Ajuste a URL
                concluirLPModal.classList.remove('hidden');
                // Adiciona animação de entrada
                setTimeout(() => {
                    concluirLPModal.firstElementChild.classList.remove('scale-95', 'opacity-0');
                    concluirLPModal.firstElementChild.classList.add('scale-100', 'opacity-100');
                }, 10);
                // Preenche a data de conclusão com a data atual por padrão
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dataConclusaoInput.value = `${year}-${month}-${day}`;
            };

            window.closeConcluirLPModal = function() {
                concluirLPModal.firstElementChild.classList.remove('scale-100', 'opacity-100');
                concluirLPModal.firstElementChild.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    concluirLPModal.classList.add('hidden');
                    formConcluirLP.reset(); // Reseta o formulário ao fechar
                    passwordErrorConcluir.classList.add('hidden'); // Oculta erro
                    passwordErrorConcluir.textContent = ''; // Limpa texto do erro
                    if (dataConclusaoInput) dataConclusaoInput.classList.remove('border-red-500'); // Remove borda de erro
                }, 300);
            };

            formConcluirLP.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                normalStateConcluir.classList.add('hidden');
                loadingStateConcluir.classList.remove('hidden');
                submitConcluirLPButton.disabled = true;
                passwordErrorConcluir.classList.add('hidden');
                passwordErrorConcluir.textContent = '';
                if (dataConclusaoInput) dataConclusaoInput.classList.remove('border-red-500');


                try {
                    const formData = new FormData(this);
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.alert && data.alert.type === 'success') {
                        if (typeof showAlert === 'function') {
                            showAlert(data.alert.type, data.alert.title, data.alert.message);
                        } else {
                            console.warn("showAlert function is not defined globally.");
                        }
                        closeConcluirLPModal();
                        // --- INÍCIO DA MODIFICAÇÃO PARA ABRIR NOVO LP MODAL ---
                        if (data.cadastro_id_para_novo_lp) { // Assumindo que a view de conclusão retornará o cadastro_id
                            if (typeof openNovoLPModal === 'function') {
                                openNovoLPModal(data.cadastro_id_para_novo_lp);
                            } else {
                                console.warn("openNovoLPModal function not found after concluding LP.");
                                // Fallback para recarregar se o novo modal não puder ser aberto
                                location.reload();
                            }
                        } else if (data.reload_page) {
                            location.reload(); 
                        } else if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        }
                        // --- FIM DA MODIFICAÇÃO ---
                    } else if (data.alert && data.alert.type === 'error') {
                        if (typeof showAlert === 'function') {
                            showAlert(data.alert.type, data.alert.title, data.alert.message);
                        } else {
                            console.warn("showAlert function is not defined globally.");
                        }
                        if (data.errors) {
                             if (data.errors.data_conclusao) { // Adapte a chave de erro se a view enviar diferente
                                 passwordErrorConcluir.textContent = data.errors.data_conclusao;
                                 passwordErrorConcluir.classList.remove('hidden');
                                 if (dataConclusaoInput) dataConclusaoInput.classList.add('border-red-500');
                             }
                             if (data.errors.password) {
                                 passwordErrorConcluir.textContent = data.errors.password; // Pode ser um erro genérico de senha
                                 passwordErrorConcluir.classList.remove('hidden');
                                 document.getElementById('passwordInputConcluir').classList.add('border-red-500');
                             }
                        } else if (data.message) { // Fallback para mensagem de erro genérica
                            passwordErrorConcluir.textContent = data.message;
                            passwordErrorConcluir.classList.remove('hidden');
                        }
                    } else {
                        if (typeof showAlert === 'function') {
                            showAlert('error', 'Erro Desconhecido!', 'Ocorreu um erro inesperado.');
                        } else {
                            console.warn("showAlert function is not defined globally.");
                        }
                    }
                } catch (error) {
                    console.error('Erro na requisição:', error);
                    if (typeof showAlert === 'function') {
                        showAlert('error', 'Erro!', 'Erro na comunicação com o servidor. Tente novamente.');
                    } else {
                        console.warn("showAlert function is not defined globally.");
                    }
                    passwordErrorConcluir.textContent = 'Erro na comunicação com o servidor. Tente novamente.';
                    passwordErrorConcluir.classList.remove('hidden');
                } finally {
                    normalStateConcluir.classList.remove('hidden');
                    loadingStateConcluir.classList.add('hidden'); // Certifique-se de que o loading desapareça
                    submitConcluirLPButton.disabled = false;
                }
            });
        }
        // --- Outros Modais e Funções de Script em detalhar_lp.html (MANTENHA OS IDs CONSISTENTES) ---

        // Lógica para a barra de progresso (adaptada do adicional) - MANTIDA AQUI
        function atualizarBarraProgresso() {
            let statusChoicesRaw = '';
            try {
                statusChoicesRaw = document.getElementById('lp_status_choices').textContent;
            } catch (e) {
                console.error("Erro ao obter textContent de 'lp_status_choices':", e);
                return;
            }
            
            let statusChoices = [];
            try {
                statusChoices = JSON.parse(statusChoicesRaw);
            } catch (e) {
                console.error("Erro ao analisar JSON de statusChoicesRaw:", e, "\nConteúdo bruto:", statusChoicesRaw);
                return;
            }

            const statusOrder = {};
            statusChoices.forEach((item, index) => {
                statusOrder[item[0]] = index;
            });

            const statusAtual = "{{ lp.status_lp }}";
            const etapaAtualIndex = statusOrder[statusAtual] || 0;
            const totalEtapas = Object.keys(statusOrder).length;
            
            const progresso = (etapaAtualIndex / (totalEtapas - 1)) * 100;
            document.querySelector('.progress-active').style.width = `${progresso}%`;
            
            if (statusAtual === 'apta_concessao') {
                document.querySelector('.progress-active').classList.add('bg-green-500');
            } else {
                document.querySelector('.progress-active').classList.remove('bg-green-500');
            }
            
            document.querySelectorAll('.step').forEach((step, index) => {
                const indicator = step.querySelector('.progress-indicator');
                const label = step.querySelector('.progress-label');
                
                indicator.className = 'progress-indicator w-6 h-6 rounded-full flex items-center justify-center relative';
                label.className = 'progress-label mt-2 text-xs text-center max-w-[90px] px-1 leading-tight';
                
                const statusKeyAtStep = statusChoices[index][0];

                if (etapaAtualIndex > index) {
                    indicator.classList.add('bg-blue-900', 'text-white');
                    indicator.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>`;
                    label.classList.add('text-blue-800');
                } else if (etapaAtualIndex === index) {
                    indicator.classList.add('bg-white', 'border-[3px]', 'border-blue-800', 'text-blue-600');
                    indicator.innerHTML = `<span class="text-[10px]">${index + 1}</span>`;
                    label.classList.add('text-blue-800');
                } else {
                    indicator.classList.add('bg-white', 'border', 'border-gray-200', 'text-gray-500');
                    indicator.innerHTML = `<span class="text-[10px]">${index + 1}</span>`;
                    label.classList.add('text-gray-600');
                }
                
                if (statusKeyAtStep === 'apta_concessao') {
                    indicator.classList.add('ring-2', 'ring-offset-2', 'ring-green-500');
                    label.classList.add('font-bold', 'text-green-700');
                    if (statusAtual === 'apta_concessao' && etapaAtualIndex === index) {
                         indicator.classList.add('faz-jus-glow');
                    }
                }
            });
        }
    
        atualizarBarraProgresso();
        
        setInterval(function() {
            fetch(window.location.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const parsedDivStatus = doc.querySelector('div[data-status]');
                    const originalStatus = "{{ lp.status_lp }}";
                    let novoStatus = null;

                    if (parsedDivStatus && parsedDivStatus.dataset.status && parsedDivStatus.dataset.status !== originalStatus) {
                        novoStatus = parsedDivStatus.dataset.status;
                    }
                    
                    if (novoStatus && novoStatus !== originalStatus) {
                        if (novoStatus === 'apta_concessao') {
                            if (typeof showAlertMessage === 'function') {
                                showAlertMessage('O status foi atualizado para Apta para Concessão!', 'success');
                            } else {
                                console.warn("showAlertMessage function is not defined. Cannot show alert.");
                            }
                        }
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar atualização de status:', error);
                });
        }, 300000); // 5 minutos em milissegundos

        // Função para mostrar/ocultar o campo da 6ª parte no modal de LP (se aplicável ao seu projeto)
        window.toggleSextaParteLp = function() {
            const numeroProxLpSelect = document.getElementById('numero_prox_lp_select');
            const sextaParteContainerLp = document.getElementById('sexta_parte_container_lp');
            const sextaParteCheckboxLp = document.getElementById('sexta_parte_lp_checkbox');
            const numeroProx = numeroProxLpSelect ? parseInt(numeroProxLpSelect.value) : null;

            if (!isNaN(numeroProx) && numeroProx === 4) {
                if (sextaParteContainerLp) sextaParteContainerLp.classList.remove('hidden');
            } else {
                if (sextaParteContainerLp) sextaParteContainerLp.classList.add('hidden');
                if (sextaParteCheckboxLp) sextaParteCheckboxLp.checked = false;
            }
        };

        // Função para exibir mensagens de alerta customizadas (se você ainda estiver usando esta, caso contrário, confie em modal_alerts.html)
        window.showAlertMessage = function(message, type) {
            const alertDiv = document.getElementById('customAlert'); // Certifique-se de ter este ID em seu HTML
            const alertIcon = document.getElementById('customAlertIcon');
            const alertMessage = document.getElementById('customAlertMessage');

            if (alertDiv && alertIcon && alertMessage) {
                alertDiv.classList.remove('alert-success', 'alert-error', 'alert-info', 'hidden');
                alertDiv.classList.add(`alert-${type}`);

                let iconSvg = '';
                if (type === 'success') {
                    iconSvg = `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                } else if (type === 'error') {
                    iconSvg = `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                } else {
                    iconSvg = `<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                }
                alertIcon.innerHTML = iconSvg;
                alertMessage.innerText = message;

                setTimeout(() => {
                    alertDiv.classList.add('hidden');
                }, 5000);
            } else {
                console.warn("Elementos para 'showAlertMessage' não encontrados. Verifique se 'customAlert', 'customAlertIcon', 'customAlertMessage' existem.");
            }
        };

        // --- Funções para Outros Modais (ajustadas para ID's genéricos e animações) ---

        window.openConfirmarSipaLpModal = function(lpPk) {
            const modal = document.getElementById('confirmarSipaLpModal');
            if (modal) {
                const form = modal.querySelector('form');
                if (form) {
                    form.action = `/lp/${lpPk}/confirmar-sipa/`;
                }
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.firstElementChild.classList.remove('scale-95', 'opacity-0');
                    modal.firstElementChild.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                console.error("Modal 'confirmarSipaLpModal' não encontrado.");
            }
        };
        window.closeConfirmarSipaLpModal = function() {
            const modal = document.getElementById('confirmarSipaLpModal');
            if (modal) {
                modal.firstElementChild.classList.remove('scale-100', 'opacity-100');
                modal.firstElementChild.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        };
        // Já definimos openConcluirLPModal e closeConcluirLPModal acima, não duplicar.

        window.openEditarDiasDescontoLPModal = function(lpPk, diasDesconto) {
            const modal = document.getElementById('editarDiasDescontoLpModal');
            if (modal) {
                const diasDescontoInput = document.getElementById('dias_desconto_lp_modal'); 
                if (diasDescontoInput) {
                    diasDescontoInput.value = diasDesconto || 0;
                } else {
                    console.error("Input 'dias_desconto_lp_modal' não encontrado no modal de edição de dias de desconto.");
                }
                
                const form = modal.querySelector('form');
                if (form) {
                    form.action = `/lp/${lpPk}/editar-dias-desconto/`;
                }
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.firstElementChild.classList.remove('scale-95', 'opacity-0');
                    modal.firstElementChild.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                console.error("Modal 'editarDiasDescontoLpModal' não encontrado.");
            }
        };
        window.closeEditarDiasDescontoLPModal = function() {
            const modal = document.getElementById('editarDiasDescontoLpModal');
            if (modal) {
                modal.firstElementChild.classList.remove('scale-100', 'opacity-100');
                modal.firstElementChild.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        };

        window.openDeleteLPModal = function(lpPk) {
            const modal = document.getElementById('excluirLpModal'); // ID sugerido para o modal de exclusão de LP
            if (modal) {
                const form = modal.querySelector('form');
                if (form) {
                    form.action = `/lp/${lpPk}/excluir/`;
                }
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.firstElementChild.classList.remove('scale-95', 'opacity-0');
                    modal.firstElementChild.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                console.error("Modal 'excluirLpModal' não encontrado.");
            }
        };
        window.closeDeleteLPModal = function() {
            const modal = document.getElementById('excluirLpModal');
            if (modal) {
                modal.firstElementChild.classList.remove('scale-100', 'opacity-100');
                modal.firstElementChild.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        };

        // --- Lógica de Submissão do Formulário SIPA (mantida, mas com animações e verificação de elementos) ---
        const formConfirmarSipaLp = document.getElementById('formConfirmarSipaLp');
        if (formConfirmarSipaLp) {
            formConfirmarSipaLp.addEventListener('submit', async function(e) {
                e.preventDefault();

                const sipaSubmitButton = formConfirmarSipaLp.querySelector('button[type="submit"]');
                const sipaNormalState = sipaSubmitButton.querySelector('#normalStateConfirmarSipa'); 
                const sipaLoadingState = sipaSubmitButton.querySelector('#loadingStateConfirmarSipa');

                if (sipaNormalState && sipaLoadingState) {
                    sipaNormalState.classList.add('hidden');
                    sipaLoadingState.classList.remove('hidden');
                }
                sipaSubmitButton.disabled = true;

                try {
                    const formData = new FormData(this);
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.alert && data.alert.type === 'success') {
                        if (typeof showAlert === 'function') {
                            showAlert(data.alert.type, data.alert.title, data.alert.message);
                        } else {
                            console.warn("showAlert function is not defined globally.");
                        }
                        closeConfirmarSipaLpModal();
                        if (data.reload_page) {
                            location.reload();
                        } else if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        }
                    } else if (data.alert && data.alert.type === 'error') {
                        if (typeof showAlert === 'function') {
                            showAlert(data.alert.type, data.alert.title, data.alert.message);
                        } else {
                            console.warn("showAlert function is not defined globally.");
                        }
                        if (data.errors) {
                             console.error("Erros específicos do modal SIPA:", data.errors);
                        }
                    } else {
                        if (typeof showAlert === 'function') {
                            showAlert('error', 'Erro Desconhecido!', 'Ocorreu um erro inesperado.');
                        } else {
                            console.warn("showAlert function is not defined globally.");
                        }
                    }
                } catch (error) {
                    console.error('Erro na requisição AJAX do modal SIPA:', error);
                    if (typeof showAlert === 'function') {
                        showAlert('error', 'Erro!', 'Erro na comunicação com o servidor. Tente novamente.');
                    } else {
                        console.warn("showAlert function is not defined globally.");
                    }
                } finally {
                    if (sipaNormalState && sipaLoadingState) {
                        sipaNormalState.classList.remove('hidden');
                        sipaLoadingState.classList.add('hidden');
                    }
                    sipaSubmitButton.disabled = false;
                }
            });
        }

        // Script para calcular tempo decorrido - MANTIDO AQUI
        const tempoDecorridoEl = document.getElementById('tempo-decorrido-lp');
        const progressoPeriodoEl = document.getElementById('progresso-periodo-lp');
        const alertaPeriodoEl = document.getElementById('alerta-periodo-lp');
        const textoAlertaEl = document.getElementById('texto-alerta-lp');
        
        function calcularTempoDecorridoLP() {
            const inicioPeriodoStr = tempoDecorridoEl ? tempoDecorridoEl.dataset.inicioPeriodo : null;

            if (!inicioPeriodoStr) {
                console.error("Data de início do período da LP não encontrada para cálculo.");
                return;
            }

            const inicioPeriodo = new Date(inicioPeriodoStr);
            const hoje = new Date();
            
            const diffEmMs = hoje - inicioPeriodo;
            const diffEmDias = Math.floor(diffEmMs / (1000 * 60 * 60 * 24));
            
            const anos = Math.floor(diffEmDias / 365);
            const meses = Math.floor((diffEmDias % 365) / 30);
            const dias = diffEmDias - (anos * 365) - (meses * 30);
            
            if (tempoDecorridoEl) {
                tempoDecorridoEl.textContent = `${anos} ano(s), ${meses} mês(es) e ${dias} dia(s)`;
            }
            
            const totalDiasPeriodo = 5 * 365;
            const progressoPercentual = Math.min((diffEmDias / totalDiasPeriodo) * 100, 100);
            
            if (progressoPeriodoEl) {
                progressoPeriodoEl.style.width = `${progressoPercentual}%`;
            }
            
            const diasRestantes = totalDiasPeriodo - diffEmDias;
            
            if (alertaPeriodoEl && textoAlertaEl) {
                alertaPeriodoEl.classList.remove('bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800', 'border-yellow-500', 'border-blue-400', 'border-green-500');
                textoAlertaEl.classList.remove('text-yellow-700', 'text-blue-700', 'text-green-700');

                const existingSvg = alertaPeriodoEl.querySelector('h3 svg');
                if (existingSvg) {
                    existingSvg.remove();
                }

                if (progressoPercentual >= 100) {
                    alertaPeriodoEl.classList.add('border-green-500');
                    textoAlertaEl.classList.add('text-green-700');
                    textoAlertaEl.textContent = 'Período aquisitivo completo!';
                    const svgIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svgIcon.classList.add("h-6", "w-6", "mr-2", "text-green-500");
                    svgIcon.setAttribute("fill", "none");
                    svgIcon.setAttribute("viewBox", "0 0 24 24");
                    svgIcon.setAttribute("stroke", "currentColor");
                    svgIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>`;
                    alertaPeriodoEl.querySelector('h3').prepend(svgIcon);
                } else if (diasRestantes <= 30) {
                    alertaPeriodoEl.classList.add('border-yellow-500');
                    textoAlertaEl.classList.add('text-yellow-700');
                    textoAlertaEl.textContent = `Faltam apenas ${diasRestantes} dias para completar o período aquisitivo!`;
                    const svgIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svgIcon.classList.add("h-6", "w-6", "mr-2", "text-yellow-500");
                    svgIcon.setAttribute("fill", "none");
                    svgIcon.setAttribute("viewBox", "0 0 24 24");
                    svgIcon.setAttribute("stroke", "currentColor");
                    svgIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>`;
                    alertaPeriodoEl.querySelector('h3').prepend(svgIcon);
                } else {
                    alertaPeriodoEl.classList.add('border-blue-400');
                    textoAlertaEl.classList.add('text-blue-700');
                    textoAlertaEl.textContent = `Faltam ${diasRestantes} dias para completar o período aquisitivo`;
                    const svgIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svgIcon.classList.add("h-6", "w-6", "mr-2", "text-blue-500");
                    svgIcon.setAttribute("fill", "none");
                    svgIcon.setAttribute("viewBox", "0 0 24 24");
                    svgIcon.setAttribute("stroke", "currentColor");
                    svgIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>`;
                    alertaPeriodoEl.querySelector('h3').prepend(svgIcon);
                }
            }
        }
        calcularTempoDecorridoLP(); // Chame a função quando o DOM estiver pronto
    });
</script>

{% endblock %}
