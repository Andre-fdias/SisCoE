name: Django CD

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        run: |
          # Use a tag do git como vers√£o
          VERSION=${GITHUB_REF#refs/tags/}
          docker build -t ${{ secrets.DOCKER_USERNAME }}/siscoe:$VERSION .
          docker push ${{ secrets.DOCKER_USERNAME }}/siscoe:$VERSION
          docker tag ${{ secrets.DOCKER_USERNAME }}/siscoe:$VERSION ${{ secrets.DOCKER_USERNAME }}/siscoe:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/siscoe:latest

      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/siscoe
            
            # AVISO DE SEGURAN√áA: Gerenciar o arquivo .env diretamente no servidor
            # √© mais seguro do que cri√°-lo via script de deploy.
            # Considere usar um sistema de gerenciamento de segredos como HashiCorp Vault ou AWS Secrets Manager.
            echo "Criando arquivo .env..."
            cat << EOF > .env
# Arquivo gerado pelo GitHub Actions - $(date)

# Django
SECRET_KEY=${{ secrets.SECRET_KEY }}
DEBUG=False
ALLOWED_HOSTS=${{ secrets.SERVER_HOST }},localhost,127.0.0.1

# Database
DB_NAME=${{ secrets.DB_NAME }}
DB_USER=${{ secrets.DB_USER }}
DB_PASSWORD=${{ secrets.DB_PASSWORD }}
DB_HOST=${{ secrets.DB_HOST }}
DB_PORT=${{ secrets.DB_PORT }}

# Redis
REDIS_URL=redis://redis:6379/0

# Email (Brevo)
BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}
DEFAULT_FROM_EMAIL=${{ secrets.DEFAULT_FROM_EMAIL }}
DEFAULT_FROM_NAME='SisCoE Sistema'

# APIs
GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
WEATHER_API_KEY=${{ secrets.WEATHER_API_KEY }}

# Telegram para notifica√ß√µes
TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}

EOF

            echo "Fazendo pull da imagem mais recente..."
            docker-compose pull web
            
            echo "Recriando os containers da aplica√ß√£o..."
            # Usa o compose de produ√ß√£o para ligar o Nginx e usar as settings corretas
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate web nginx celery celery-beat
            
            echo "Aguardando o container 'web' ficar saud√°vel..."
            # Este loop espera at√© 60s para o servi√ßo web estar pronto antes de continuar
            timeout 60s bash -c 'while [[ "$(docker-compose ps -q web)" == "" || "$(docker inspect -f {{.State.Health.Status}} $(docker-compose ps -q web))" != "healthy" ]]; do echo "...aguardando servi√ßo web..."; sleep 3; done'

            echo "Executando migra√ß√µes..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput
            
            echo "Coletando arquivos est√°ticos..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput --clear
            
            echo "Limpando imagens Docker n√£o utilizadas..."
            docker image prune -f

            echo "Deploy da vers√£o ${GITHUB_REF#refs/tags/} conclu√≠do!"

      - name: Notify via Telegram
        if: always()
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üöÄ Deploy Status: ${{ job.status }}
            ‚úÖ Version: ${GITHUB_REF#refs/tags/}
            üîó Branch: ${{ github.ref_name }}
            üë§ By: ${{ github.actor }}
            üìù Commit: ${GITHUB_SHA:0:7}
            üîç Details: https://github.com/${{ github.repository }}/commit/${{ github.sha }}