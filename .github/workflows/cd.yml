name: Django CD

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        run: |
          # Use a tag do git como vers√£o
          VERSION=${GITHUB_REF#refs/tags/}
          docker build -t ${{ secrets.DOCKER_USERNAME }}/siscoe:$VERSION .
          docker push ${{ secrets.DOCKER_USERNAME }}/siscoe:$VERSION
          docker tag ${{ secrets.DOCKER_USERNAME }}/siscoe:$VERSION ${{ secrets.DOCKER_USERNAME }}/siscoe:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/siscoe:latest

      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/siscoe
            
            echo "Criando arquivo .env..."
            cat << EOF > .env
# Arquivo gerado pelo GitHub Actions - $(date)

# Django
SECRET_KEY='${{ secrets.SECRET_KEY }}'
DEBUG=False
ALLOWED_HOSTS=${{ secrets.SERVER_HOST }},localhost,127.0.0.1

# Database
DB_NAME=${{ secrets.DB_NAME }}
DB_USER=${{ secrets.DB_USER }}
DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
DB_HOST=${{ secrets.DB_HOST }}
DB_PORT=${{ secrets.DB_PORT }}

# Email (Brevo)
BREVO_API_KEY='${{ secrets.BREVO_API_KEY }}'
DEFAULT_FROM_EMAIL=${{ secrets.DEFAULT_FROM_EMAIL }}
DEFAULT_FROM_NAME='SisCoE Sistema'

# APIs
GROQ_API_KEY='${{ secrets.GROQ_API_KEY }}'
WEATHER_API_KEY='${{ secrets.WEATHER_API_KEY }}'

# Telegram para notifica√ß√µes
TELEGRAM_BOT_TOKEN='${{ secrets.TELEGRAM_BOT_TOKEN }}'
TELEGRAM_CHAT_ID='${{ secrets.TELEGRAM_CHAT_ID }}'

EOF

            echo "Fazendo pull das imagens Docker..."
            docker-compose pull app
            
            echo "Recriando os containers..."
            docker-compose down
            docker-compose up -d
            
            echo "Executando migra√ß√µes..."
            docker-compose exec -T app python manage.py migrate --noinput
            
            echo "Coletando arquivos est√°ticos..."
            docker-compose exec -T app python manage.py collectstatic --noinput --clear
            
            echo "Deploy da vers√£o ${GITHUB_REF#refs/tags/} conclu√≠do!"

      - name: Notify via Telegram
        if: always()
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üöÄ Deploy Status: ${{ job.status }}
            ‚úÖ Version: ${GITHUB_REF#refs/tags/}
            üîó Branch: ${{ github.ref_name }}
            üë§ By: ${{ github.actor }}
            üìù Commit: ${GITHUB_SHA:0:7}
            üîç Details: https://github.com/${{ github.repository }}/commit/${{ github.sha }}