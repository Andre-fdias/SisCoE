# /docker/prod/nginx.prod.conf

# Define o upstream para o serviço da aplicação Django (Daphne)
upstream django_server {
    # O nome 'web' corresponde ao nome do serviço no docker-compose
    server web:8000;
}

# Servidor para redirecionar HTTP para HTTPS
server {
    listen 80;
    server_name SEU_DOMINIO.COM; # Substitua pelo seu domínio

    # Redirecionamento permanente para a versão HTTPS
    return 301 https://$host$request_uri;
}

# Servidor principal que lida com o tráfego HTTPS
server {
    listen 443 ssl;
    server_name SEU_DOMINIO.COM; # Substitua pelo seu domínio

    # --- Configuração SSL ---
    # Substitua pelos caminhos dos seus certificados SSL no servidor
    # Exemplo para Let's Encrypt:
    # ssl_certificate /etc/letsencrypt/live/SEU_DOMINIO.COM/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/SEU_DOMINIO.COM/privkey.pem;
    
    # Placeholder - Descomente e ajuste as linhas acima quando tiver os certificados
    ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;
    
    # Melhora a segurança do SSL
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers off;

    # Define o tamanho máximo do corpo da requisição (ex: para uploads)
    client_max_body_size 20M;

    # --- Servir Arquivos Estáticos e de Mídia ---
    # Estes são servidos diretamente pelo Nginx para performance
    
    location /static/ {
        # O alias aponta para o volume compartilhado de estáticos
        alias /app/staticfiles/;
        expires 30d;
        add_header Cache-Control "public";
    }

    location /media/ {
        # O alias aponta para o volume compartilhado de mídia
        alias /app/media/;
        expires 30d;
        add_header Cache-Control "public";
    }

    # --- Proxy para a Aplicação Django ---
    # Todas as outras requisições são enviadas para o Django
    location / {
        proxy_pass http://django_server;
        
        # Headers essenciais para o proxy reverso
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # --- Configuração para WebSockets (Chat) ---
        # Necessário para o funcionamento do Django Channels
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts para conexões de longa duração
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }
}
